<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gestor de Tokens</title>

<style>
/* === CSS ORIGINAL (INALTERADO) === */
* { box-sizing: border-box; }

body {
  font-family: Arial, Helvetica, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  margin: 0;
  padding: 16px;
}

.card {
  max-width: 920px;
  margin: 24px auto;
  background: #020617;
  border-radius: 14px;
  padding: 20px;
  width: 100%;
}

h2 { margin: 0 0 16px; }

input, select, button {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #1f2937;
  background: #020617;
  color: #e5e7eb;
}

button {
  background: #2563eb;
  border: none;
  font-weight: 700;
  cursor: pointer;
}

.row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
  margin-bottom: 14px;
}

@media (max-width: 720px) {
  .row { grid-template-columns: 1fr; }
}

.hidden { display: none; }

.links {
  background: #020617;
  border: 1px dashed #334155;
  padding: 12px;
  border-radius: 10px;
  word-break: break-all;
  margin-bottom: 14px;
  line-height: 1.6;
}

.oculto { display: none; }
</style>
</head>

<body>

<div class="card" id="login">
  <h2>Login</h2>
  <input type="password" id="senha" placeholder="Senha" />
  <button onclick="login()">Entrar</button>
</div>

<div class="card hidden" id="loading">
  <h2>Validando acesso…</h2>
  <p>Carregando dados do sistema, aguarde.</p>
</div>

<div class="card hidden" id="app">
  <h2>Gerar Tokens</h2>

  <div id="boasVindas">
    Olá, seja bem-vindo(a), <strong><span id="nomeVendedor"></span></strong>
  </div>

  <div class="row">
    <select id="curso"></select>
    <select id="turma"></select>
  </div>

  <div id="info" class="links hidden"></div>

  <div class="row oculto">
    <input id="quantidade" type="number" value="1" min="1" />
    <input id="idPlanilha" />
  </div>

  <button id="btnGerar" onclick="gerar()">Gerar</button>
  <div id="resultado" class="links hidden"></div>
</div>

<script>
/* ===============================
   CONFIGURAÇÃO
================================ */
const API_URL = "https://script.google.com/macros/s/AKfycby7f6jBAOzk2h7I6tV67fq-_NVQjQ96Hr_CeK6mu0_Nw3OfJGNOv8NAxP0_HZLA_fycLQ/exec";

/* ===============================
   UTIL
================================ */
function copiar(texto) {
  const t = document.createElement("textarea");
  t.value = texto;
  document.body.appendChild(t);
  t.select();
  document.execCommand("copy");
  document.body.removeChild(t);
}

/* ===============================
   LOGIN
================================ */
async function login() {
  const senha = document.getElementById("senha").value;

  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      acao: "loginCursos",
      senha
    })
  }).then(r => r.json());

  if (!res.ok) {
    alert("Acesso não autorizado");
    return;
  }

  document.getElementById("login").classList.add("hidden");
  document.getElementById("loading").classList.remove("hidden");

  document.getElementById("idPlanilha").value = "";
  document.getElementById("nomeVendedor").textContent = "";

  await carregarCursos();

  document.getElementById("loading").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");

  window.SENHA_ATUAL = senha;
}

/* ===============================
   CURSOS
================================ */
let cursos = [];

async function carregarCursos() {
  const res = await fetch(`${API_URL}?acao=listarCursos`);
  cursos = await res.json();

  const sel = document.getElementById("curso");
  sel.innerHTML = `<option value="">Selecione o curso</option>`;

  [...new Set(cursos.filter(c => c.ativo).map(c => c.nome))]
    .forEach(nome => {
      sel.innerHTML += `<option value="${nome}">${nome}</option>`;
    });
}

document.getElementById("curso").addEventListener("change", e => {
  const nome = e.target.value;
  const sel = document.getElementById("turma");
  sel.innerHTML = `<option value="">Selecione a turma</option>`;

  cursos
    .filter(c => c.nome === nome && c.ativo)
    .forEach(c => {
      sel.innerHTML += `<option value="${c.turma}">${c.turma}</option>`;
    });
});

document.getElementById("turma").addEventListener("change", () => {
  const nome = curso.value;
  const turma = document.getElementById("turma").value;
  const c = cursos.find(x => x.nome === nome && x.turma === turma);
  if (!c) return;

  const box = document.getElementById("info");
  box.classList.remove("hidden");
  box.innerHTML = `
    <strong>Curso:</strong> ${c.nome}<br>
    <strong>Turma:</strong> ${c.turma}<br>
    <strong>Local:</strong> ${c.local}<br>
    <strong>Data:</strong> ${c.data}
  `;
});

/* ===============================
   GERAR TOKENS
================================ */
async function gerar() {
  const btn = document.getElementById("btnGerar");
  const nomeCurso = curso.value;
  const turma = document.getElementById("turma").value;

  if (!nomeCurso || !turma) {
    alert("Selecione curso e turma");
    return;
  }

  btn.disabled = true;

  const payload = {
    acao: "gerarTokens",
    senha: window.SENHA_ATUAL,
    payload: {
      curso: cursos.find(c => c.nome === nomeCurso && c.turma === turma),
      turma,
      quantidade: 1,
      idPlanilha: document.getElementById("idPlanilha").value
    }
  };

  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  }).then(r => r.json());

  const box = document.getElementById("resultado");
  box.classList.remove("hidden");
  box.innerHTML = res.links.map(l => `<div>${l}</div>`).join("");

  copiar(res.links.join("\n"));

  btn.disabled = false;
}
</script>

</body>
</html>
