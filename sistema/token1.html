<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gestor de Tokens</title>

<style>
* {
  box-sizing: border-box;
}

body {
  font-family: Arial, Helvetica, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  margin: 0;
  padding: 16px;
}


.card {
  max-width: 920px;
  margin: 24px auto;
  background: #020617;
  border-radius: 14px;
  padding: 20px;
  width: 100%;
}

h2 {
  margin: 0 0 16px;
}

input, select, button {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #1f2937;
  background: #020617;
  color: #e5e7eb;
}

/* BotÃ£o com efeito */
button {
  background: #2563eb;
  border: none;
  font-weight: 700;
  cursor: pointer;
  transition: transform .1s ease, box-shadow .1s ease, opacity .2s ease;
}

button:active {
  transform: scale(0.97);
  box-shadow: inset 0 2px 6px rgba(0,0,0,.4);
  opacity: .9;
}

/* Grid correto */
.row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
  margin-bottom: 14px;
}

/* Mobile */
@media (max-width: 720px) {
  .row {
    grid-template-columns: 1fr;
  }
}

.hidden {
  display: none;
}

.links {
  background: #020617;
  border: 1px dashed #334155;
  padding: 12px;
  border-radius: 10px;
  word-break: break-all;
  margin-bottom: 14px;
}

/* EspaÃ§o entre botÃ£o Gerar e resultado */
#resultado {
  margin-top: 14px;
}

/* EspaÃ§amento vertical entre campos e botÃµes dentro dos cards */
.card > input,
.card > button {
  margin-top: 12px;
}

/* ðŸ”’ OCULTAR CAMPOS OPERACIONAIS
   Para reativar no futuro, remova a classe "oculto" do HTML */
.oculto {
  display: none;
}


.links {
  line-height: 1.6; /* ðŸ‘ˆ espaÃ§o entre linhas */
}

</style>
</head>
<body>
<div class="card" id="login">
<h2>Login</h2>
<input type="password" id="senha" placeholder="Senha" />
<button onclick="login()">Entrar</button>
</div>


<div class="card hidden" id="loading">
  <h2>Validando acessoâ€¦</h2>
  <p>Carregando dados do sistema, aguarde.</p>
</div>



<div class="card hidden" id="app">
<h2>Gerar Tokens</h2>



<!-- ðŸ‘‹ Mensagem de boas-vindas ao vendedor -->
<div id="boasVindas" style="margin-bottom:16px;">
  <div style="font-size:16px;font-weight:600;">
    OlÃ¡, seja bem-vindo(a), <span id="nomeVendedor"></span>
  </div>

  <div style="font-size:15px;color:#94a3b8;margin-top:6px;line-height:1.4;">
    Selecione o curso e a turma para a qual o aluno estÃ¡ se inscrevendo.
    Antes de gerar o link, confira atentamente os dados do treinamento
    (turma, local, data e observaÃ§Ãµes) para garantir que o link seja gerado corretamente.
  </div>
</div>









<div class="row">
  <select id="curso"></select>
  <select id="turma"></select>
</div>

<div id="info" class="links hidden"></div>


<!-- ðŸ”’ CAMPOS OCULTOS (quantidade fixa = 1 | vendedor automÃ¡tico)
     Para liberar no futuro, basta remover a classe "oculto" -->
<div class="row oculto">
  <input id="quantidade" type="number" value="1" min="1" />
  <input id="idPlanilha" placeholder="Vendedor responsÃ¡vel (obrigatÃ³rio)" />
</div>


<button id="btnGerar" onclick="gerar()">Gerar</button>
<div id="resultado" class="links hidden"></div>
</div>


  <script src="/js/igc-config.js"></script>

  
<script>


const API = window.IGC_CONFIG.APPS_SCRIPT_BASE;

let SENHA = "";
let PERFIL = "";
let PERMISSOES = [];


async function login() {
  const senha = senhaLogin.value.trim();
  loginErro.innerText = "";

  if (!senha) {
    loginErro.innerText = "Informe a senha.";
    return;
  }

  try {
    const res = await fetch(API, {
      method: "POST",
      body: JSON.stringify({
        acao: "loginCursos",
        senha
      })
    }).then(r => r.json());

    if (!res.ok) {
      loginErro.innerText = "Senha invÃ¡lida.";
      return;
    }

    // ðŸ” opcional: controle por permissÃ£o
    if (!res.permissoes || !res.permissoes.length) {
      loginErro.innerText = "UsuÃ¡rio sem permissÃµes.";
      return;
    }

    // âœ… LOGIN OK
    SENHA = senha;
    PERFIL = res.perfil || "";
    PERMISSOES = res.permissoes || [];

    // âœ… SALVA A SENHA (AQUI Ã‰ O ÃšNICO LUGAR CERTO)
  localStorage.setItem("IGC_SENHA", senha);

    // some login
    loginBox.style.display = "none";

    // loading
    loadingBox.style.display = "flex";

    setTimeout(() => {
      loadingBox.style.display = "none";
      appBox.style.display = "flex";
      document.body.style.overflow = "hidden";
    }, 1200);

  } catch (err) {
    console.error(err);
    loginErro.innerText = "Erro ao validar acesso.";
  }
}





  





  


function copiar(texto) {
  const t = document.createElement('textarea');
  t.value = texto;
  document.body.appendChild(t);
  t.select();
  document.execCommand('copy');
  document.body.removeChild(t);
}














let cursos = [];

function carregarCursos(callback) {
  fetch(API_URL + "?acao=listarCursos")
    .then(r => r.json())
    .then(list => {

      cursos = list;

      const selCurso = document.getElementById('curso');
      selCurso.innerHTML = '<option value="">Selecione o curso</option>';

      [...new Set(list.filter(c => c.ativo === true).map(c => c.nome))]
        .forEach(nome => {
          const o = document.createElement('option');
          o.value = nome;
          o.textContent = nome;
          selCurso.appendChild(o);
        });

      if (callback) callback();
    });
}





document.getElementById('curso').addEventListener('change', e=>{
  const nomeCurso = e.target.value;
  const selTurma = document.getElementById('turma');

  selTurma.innerHTML = '<option value="">Selecione a turma</option>';
  document.getElementById('info').classList.add('hidden');

  cursos
  .filter(c => c.nome === nomeCurso && c.ativo === true)
  .forEach(c=>{
    const o = document.createElement('option');
    o.value = c.turma;
    o.textContent = c.turma;
    selTurma.appendChild(o);
  });
});


document.getElementById('turma').addEventListener('change', ()=>{
  const nomeCurso = document.getElementById('curso').value;
  const turma = document.getElementById('turma').value;

  const c = cursos.find(x => x.nome === nomeCurso && x.turma === turma);
  if (!c) return;

  const box = document.getElementById('info');
  box.classList.remove('hidden');
  box.innerHTML = `
    <strong>Confirme os dados:</strong><br>
    <strong>Curso:</strong> ${c.nome}<br>
    <strong>Turma:</strong> ${c.turma}<br>
    <strong>Local:</strong> ${c.local}<br>
    <strong>Data:</strong> ${c.data}<br>
    <strong>ObservaÃ§Ã£o:</strong> ${c.obs || '-'}
  `;
});







function gerar() {
  const btn = document.getElementById('btnGerar');

  const nomeCurso = document.getElementById('curso').value;
  const turma = document.getElementById('turma').value;

  if (!nomeCurso || !turma) {
    alert('Selecione o curso e a turma');
    return;
  }

  const vendedor = document.getElementById('idPlanilha').value.trim();
  if (!vendedor) {
    alert('Informe o vendedor');
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Gerando link...';

  const curso = cursos.find(c => c.nome === nomeCurso && c.turma === turma);

  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      acao: "gerarTokens",
      senha: document.getElementById('senha').value,
      payload: {
        curso,
        turma,
        quantidade: 1,
        idPlanilha: vendedor
      }
    })
  })
  .then(r => r.json())
  .then(resp => {

    if (!resp.ok) {
      alert("Erro ao gerar token");
      return;
    }

    const box = document.getElementById('resultado');
    box.classList.remove('hidden');
    box.innerHTML = resp.links.map(l => `<div>${l}</div>`).join('');

    copiar(resp.links.join('\n'));
    alert('âœ… Link copiado');

    btn.disabled = false;
    btn.textContent = 'Gerar';
  })
  .catch(() => {
    alert('Erro de conexÃ£o');
    btn.disabled = false;
    btn.textContent = 'Gerar';
  });
}



</script>


</body>
</html>
