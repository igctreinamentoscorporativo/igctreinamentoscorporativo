<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">   
<meta charset="UTF-8">
<title>CRM LEADS WHTASAPP</title>

<style>

html, body{
  overflow-x:hidden;
}

html, body{
  height:100%;
}
  
   
/* ===============================
   üî• BASE VISUAL PROFISSIONAL
================================ */
body{
  background:#0f0f0f;
  color:#fff;
  font-family:Segoe UI, Arial;
  margin:0;
  min-height:100dvh;
  padding-bottom: env(safe-area-inset-bottom);
}

  
header{
  padding:20px;
  font-size:22px;
  font-weight:600;
  letter-spacing:1px;
  border-bottom:1px solid #222;
}

.container{
  padding:20px 30px;
}

/* ===============================
   üîπ FORM CARD
================================ */
.card{
  background:#181818;
  padding:20px;
  border-radius:8px;
  box-shadow:0 0 10px rgba(0,0,0,.4);
  margin-bottom:20px;
}

.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

input, select, textarea{
  background:#111;
  border:1px solid #333;
  color:#fff;
  padding:8px;
  border-radius:5px;
  outline:none;
  font-size:13px;
}

input:focus, select:focus, textarea:focus{
  border:1px solid #00bfff;
}

input{
  text-transform:uppercase;
}

textarea{
  resize:none;
  text-transform:uppercase;
}

button{
  background:#00bfff;
  border:none;
  padding:9px 14px;
  border-radius:5px;
  cursor:pointer;
  font-weight:600;
  font-size:12px;
  transition: all .15s ease;
  box-shadow:0 4px 0 #0080aa;
}

button:hover{
  background:#009acd;
}

button:active{
  transform: translateY(3px);
  box-shadow:0 1px 0 #0080aa;
}

.btn-secondary{
  background:#333;
}

.btn-secondary:hover{
  background:#444;
}


   
/* ===============================
   üîπ TABELA CRM
================================ */
.table{
  width:100%;
  border-collapse:collapse;
}

.table th{
  background:#1e1e1e;
  padding:10px;
  text-align:left;
  font-size:12px;
  letter-spacing:.5px;
  cursor:pointer;
}

.table td{
  padding:10px;
  border-bottom:1px solid #222;
  font-size:13px;
}

.table tr:hover{
  background:#1a1a1a;
}

.status{
  padding:4px 8px;
  border-radius:12px;
  font-size:11px;
  font-weight:bold;
}

.LEAD{background:#555;}
.EM-CONTATO{background:#0066cc;}
.NEGOCIA√á√ÉO{background:#ff9900;}
.FECHADO{background:#00aa55;}
.PERDIDO{background:#aa0000;}
.LISTA-DE-ESPERA{background:#7e22ce;}
.QUALIFICADO{background:#0ea5a4;} 
.MATURA√á√ÉO-DE-VALOR{background:#b45309;}
.AGUARDANDO-PAGAMENTO{background:#1d4ed8;}

  
.search-box{
  margin-bottom:10px;
}



.btn-novo-lead-mobile{
  display:none;
}
  

.card-title{
  margin:0 0 15px 0;
  font-size:16px;
  font-weight:600;
  letter-spacing:.5px;
  color:#00bfff;
  border-bottom:1px solid #222;
  padding-bottom:8px;
}

  


/* ===============================
   üî• MODAL DETALHES
================================ */
.modal{
  position:fixed;
  top:0;
  right:0;
  width:100%;
  height:100dvh; /* üî• troca aqui */
  background:#121212;
  padding:40px 35px 120px 35px; /* üî• adiciona espa√ßo embaixo */
  overflow-y:auto;
  overflow-x:hidden;
  transform:translateX(100%);
  transition:transform .35s ease;
  z-index:9999;
  box-sizing:border-box;
}

.modal.active{
  transform:translateX(0);
}

.modal h3{
  margin-top:50px;
  margin-bottom:20px;
  font-size:22px;
}

.modal-close{
  position:absolute;
  top:20px;
  right:25px;
  background:#1f2937;
  padding:8px 14px;
  border-radius:6px;
  font-size:13px;
  font-weight:600;
  cursor:pointer;
  color:#fff;
  border:1px solid #374151;
  transition:.2s;
}


.modal-close:hover{
  background:#00bfff;
  color:#000;
}
  

  


/* ===============================
   üî• MODAL DETALHES EDI√á√ÉO
================================ */


.form-group{
  display:flex;
  flex-direction:column;
  margin-bottom:12px;
}

.form-group label{
  font-size:11px;
  color:#9ca3af;
  margin-bottom:4px;
  letter-spacing:.5px;
}

  
  
  



/* ===============================
   üìä DASHBOARD CRM
================================ */
.dashboard{
  display:flex;
  gap:15px;
  margin-bottom:20px;
  flex-wrap:wrap;
}

.kpi{
  flex:1;
  min-width:150px;
  background:#181818;
  padding:15px;
  border-radius:8px;
  text-align:center;
  box-shadow:0 0 10px rgba(0,0,0,.3);
}

.kpi h4{
  margin:0;
  font-size:12px;
  letter-spacing:.5px;
  color:#aaa;
}

.kpi span{
  display:block;
  font-size:22px;
  margin-top:5px;
  font-weight:bold;
}
   
   

.kpi{ cursor:pointer; transition:.2s; }
.kpi:hover{ transform:scale(1.05); }
.kpi-total{ background:#2b2b2b; }
.kpi-contato{ background:#004c99; }
.kpi-negociacao{ background:#cc8400; }
.kpi-fechado{ background:#006633; }
.kpi-perdido{ background:#660000; }
.kpi-espera{ background:#6b21a8; } /* Roxo elegante */
.kpi-lead{ background:#3a3a3a; }
.kpi-qualificado{ background:#0d9488; }  
.kpi-maturacao{ background:#92400e; }
.kpi-aguardando{ background:#1e40af; }


  

.kpi.active{
  outline:2px solid #00bfff;
}
   



 /* ===============================
   CSS DE TELA DE LOGIN
================================ */



.login-screen,
.loading-screen{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:linear-gradient(135deg,#000428,#004e92);
  display:flex;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  z-index:9999;
}

.login-box{
  width:350px;
  background:#0b0f2a;
  padding:30px;
  border-radius:10px;
  box-shadow:0 0 30px rgba(0,0,0,.5);
  text-align:left;
}

.login-box h2{
  margin-top:0;
}

.login-box input{
  width:100%;
  padding:10px;
  margin-top:10px;
  background:#111;
  border:1px solid #333;
  color:#fff;
}

.login-box button{
  width:100%;
  margin-top:15px;
  padding:12px;
  background:#3b82f6;
  border:none;
  font-weight:bold;
  cursor:pointer;
}

.login-box button:hover{
  background:#2563eb;
}

.erro-login{
  margin-top:10px;
  color:#ff4d4d;
  font-size:13px;
}

.loading-screen{
  display:none;
  text-align:center;
}





  /* ===============================
  BOT√ÉO DELETAR EXCLUIR
================================ */

.btn-delete{
  background:#cc0000;
  box-shadow:0 4px 0 #990000;
  color:#fff;
  font-size:14px;
  padding:8px 12px;
}

.btn-delete:hover{
  background:#ff0000;
}

.btn-delete:active{
  box-shadow:0 1px 0 #990000;
}


/* ===============================
   DESABILITA BOT√ïES PERFIL VER
================================ */

.btn-disabled{
  opacity:0.4 !important;
  cursor:not-allowed !important;
  pointer-events:none;
}

   


   /* ===============================
   RESPONSIVIDADE TELA CELULAR
================================ */
   
@media(max-width:768px){

  body{
    font-size:15px;
  }

  .container{
    padding:20px 30px 120px 30px;
  }

  .dashboard{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }

  .kpi{
    min-width:auto;
    padding:12px;
  }

  .card{
    padding:15px;
  }

  .row{
    flex-direction:column;
    gap:12px;
  }

  input, select, textarea{
    font-size:15px;
    padding:12px;
  }

  button{
    width:100%;
    padding:14px;
    font-size:14px;
  }

  .table{
    font-size:13px;
  }

  header{
    font-size:18px;
    text-align:center;
  }

   input, select, textarea {
  width: 100%;
  box-sizing: border-box;
}


 .modal{
  width:100%;
  padding:20px;
}


/* ===============================
  MODAL DE EDI√á√ÉO
================================ */


.form-group{
  margin-bottom:18px;
}

.form-group label{
  font-size:12px;
  color:#a1a1aa;
}

.form-group input,
.form-group select,
.form-group textarea{
  font-size:16px;
  padding:14px;
}


#novaObs{
  min-height:140px;
  font-size:16px;
}



/* ===============================
   NOVO LEAD BOT√ÉO MOBILE
================================ */

#formNovoLead{
  display:none;
}

.btn-novo-lead-mobile{
  display:block;
  width:100%;
  background:#ffffff;
  color:#000000;
  font-weight:700;
  margin-bottom:15px;
  border-radius:8px;
}

.btn-novo-lead-mobile:hover{
  background:#f1f1f1;
}



  
/* ===============================
   BOT√ÉO DELETAR EXLUIR MOBILE
================================ */


.table td:nth-child(4){
  display:flex;
  gap:10px;
  margin-top:12px;
}

.table td:nth-child(4) button{
  flex:1;
  padding:12px;
  font-size:16px;
}


  
  

/* ===============================
   üî• TABELA MOBILE ESTILO CARD
================================ */

.table thead{
  display:none;
}

.table,
.table tbody,
.table tr,
.table td{
  display:block;
  width:100%;
}

/* Card */
.table tr{
  background:#141414;
  margin-bottom:14px;
  padding:16px;
  border-radius:10px;
  border:1px solid #222;
}

/* Zebra */
.table tr:nth-child(even){
  background:#181818;
}

/* Remove bordas internas */
.table td{
  border:none;
  padding:6px 0;
}

/* ===============================
   üß† Nome + Status
================================ */

.table td:nth-child(1){
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:16px;
  font-weight:600;
}

/* ===============================
   üìå √öltima intera√ß√£o
================================ */

/* üìå Linha 2 ‚Äî √öltima intera√ß√£o */
.table td:nth-child(3){
  font-size:13px;
  color:#bbb;
  margin-bottom:10px;
}

/* T√≠tulo pequeno acima */
.table td:nth-child(3)::before{
  content:"√öLTIMA INTERA√á√ÉO";
  display:block;
  font-size:11px;
  letter-spacing:.5px;
  color:#888;
  margin-bottom:4px;
}
/* ===============================
   üéØ Status
================================ */

.table td:nth-child(2){
  margin-top:6px;
}

/* ===============================
   üéØ Bot√µes
================================ */

.table td:nth-child(4){
  display:flex;
  gap:10px;
  margin-top:12px;
}

.table td:nth-child(4) button{
  flex:1;
  padding:12px;
  font-size:16px;
}

 
 
  
}


   

   
</style>
</head>
<body>


<div id="loginScreen" class="login-screen">

  <div class="login-box">
    <h2>Acesso Restrito</h2>
    <p>Senha de acesso</p>

    <input type="password" id="senhaLogin">
    <button onclick="fazerLogin()">Entrar</button>

    <div id="erroLogin" class="erro-login"></div>
  </div>

</div>

<div id="loadingScreen" class="loading-screen">
  <h1>IGC Treinamentos Corporativo</h1>
  <p>Carregando sistema...</p>
</div>

<div id="crmSistema" style="display:none;">


  
<header>GEST√ÉO DE LEADS</header>


<div class="container">

<div class="dashboard">

  

  <div class="kpi kpi-lead" onclick="filtrarStatus(event,'LEAD')">
  <h4>LEADS</h4>
  <span id="kpiLead">0</span>
</div>


  

  <div class="kpi kpi-contato" onclick="filtrarStatus(event,'EM CONTATO')">
    <h4>EM CONTATO</h4>
    <span id="kpiContato">0</span>
  </div>



<div class="kpi kpi-qualificado" onclick="filtrarStatus(event,'QUALIFICADO')">
  <h4>QUALIFICADO</h4>
  <span id="kpiQualificado">0</span>
</div>

  

  <div class="kpi kpi-negociacao" onclick="filtrarStatus(event,'NEGOCIA√á√ÉO')">
    <h4>NEGOCIA√á√ÉO</h4>
    <span id="kpiNegociacao">0</span>
  </div>




<div class="kpi kpi-maturacao" onclick="filtrarStatus(event,'MATURA√á√ÉO DE VALOR')">
  <h4>MATURA√á√ÉO</h4>
  <span id="kpiMaturacao">0</span>
</div>





  <div class="kpi kpi-aguardando" onclick="filtrarStatus(event,'AGUARDANDO PAGAMENTO')">
  <h4>AG. PAGAMENTO</h4>
  <span id="kpiAguardando">0</span>
</div>

  

  

  <div class="kpi kpi-fechado" onclick="filtrarStatus(event,'FECHADO')">
    <h4>FECHADOS</h4>
    <span id="kpiFechados">0</span>
  </div>

  <div class="kpi kpi-perdido" onclick="filtrarStatus(event,'PERDIDO')">
    <h4>PERDIDOS</h4>
    <span id="kpiPerdidos">0</span>
  </div>


  <div class="kpi kpi-espera" onclick="filtrarStatus(event,'LISTA DE ESPERA')">
  <h4>LISTA DE ESPERA</h4>
  <span id="kpiEspera">0</span>
</div>



  <div class="kpi kpi-total" onclick="filtrarStatus(event,'TODOS')">
    <h4>TOTAL</h4>
    <span id="kpiTotal">0</span>
  </div>
  

  

</div>
   


<div class="card" id="cardNovoLead">
<h3 class="card-title">CADASTRAR NOVO LEAD</h3>

  <!-- Bot√£o mobile -->
<button id="btnNovoLeadMobile" class="btn-novo-lead-mobile" onclick="toggleNovoLead()">
  + NOVO LEAD
</button>

<div class="row" id="formNovoLead">

<input id="nome" placeholder="NOME">
<input id="telefone" placeholder="TELEFONE">
<input id="cidade" placeholder="CIDADE">
<input id="servico" placeholder="SERVI√áO">

<select id="status">
  <option>LEAD</option>
  <option>EM CONTATO</option>
  <option>QUALIFICADO</option>
  <option>NEGOCIA√á√ÉO</option>
  <option>MATURA√á√ÉO DE VALOR</option>
  <option>AGUARDANDO PAGAMENTO</option>
  <option>FECHADO</option>
  <option>PERDIDO</option>
  <option>LISTA DE ESPERA</option>
</select>

<input type="date" id="dataContato">
<input type="time" id="horaContato">

  
<textarea id="obs" placeholder="OBSERVA√á√ïES" rows="2"></textarea>

<button onclick="salvar()">SALVAR</button>

</div>
</div>

<div class="card">
<h3 class="card-title">FILTRAR LEADS</h3>
<div class="search-box row">

<input id="filtroNome" placeholder="BUSCAR NOME" onkeyup="render()">
<input id="filtroTelefone" placeholder="BUSCAR TELEFONE" onkeyup="render()">

<input type="date" id="filtroDataInicio" onchange="render()">
<input type="date" id="filtroDataFim" onchange="render()">


 <select id="filtroTurma" onchange="render()">
  <option value="">FILTRAR TURMA</option>
</select> 
  

<select id="filtroCidade" onchange="render()">
  <option value="">FILTRAR CIDADE</option>
</select>

<select id="filtroStatus" onchange="render()">
  <option value="">FILTRAR STATUS</option>
  <option value="LEAD">LEAD</option>
  <option value="EM CONTATO">EM CONTATO</option>
  <option value="QUALIFICADO">QUALIFICADO</option>
  <option value="MATURA√á√ÉO DE VALOR">MATURA√á√ÉO DE VALOR</option>
  <option value="AGUARDANDO PAGAMENTO">AGUARDANDO PAGAMENTO</option>
  <option value="NEGOCIA√á√ÉO">NEGOCIA√á√ÉO</option>
  <option value="FECHADO">FECHADO</option>
  <option value="PERDIDO">PERDIDO</option>
  <option value="LISTA DE ESPERA">LISTA DE ESPERA</option>
  
</select>  

<button class="btn-secondary" onclick="limparFiltros()">LIMPAR FILTROS</button>

</div>

<table class="table">
<thead>
<tr>
<th onclick="ordenar(3)">NOME</th>
<th onclick="ordenar(7)">STATUS</th>
<th>√öLTIMA INTERA√á√ÉO</th>
<th>A√á√ïES</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

</div>

<script>

const ENDPOINT = "https://script.google.com/macros/s/AKfycbywcA-6fHHpCUfHCbCV1N6uqKdMzWMJTQozBktItBNZESUnqBjfJF4IIO1yjSmdBap2fQ/exec";

let SENHA = "";
let dadosGlobais = [];
let ordemAsc = true;
let statusSelecionado = "TODOS";
let leadEmEdicao = null;  
let idEditando = null;
let autoRefreshInterval = null;  
let SOMENTE_LEITURA = false;


// ===============================
// üîí SENHA DE LOGIN
// ===============================


function fazerLogin(){

  const senhaDigitada = document.getElementById("senhaLogin").value;

  fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      acao:"loginCursos",
      senha:senhaDigitada
    })
  })
  .then(r=>r.json())
  .then(res=>{
  console.log("RES LOGIN:", res);
    if(res.ok){

      SENHA = senhaDigitada;

     if(res.perfil === "CRM_LEADS_VER"){SOMENTE_LEITURA = true;}

      
      document.getElementById("loginScreen").style.display="none";
      document.getElementById("loadingScreen").style.display="flex";

      setTimeout(()=>{
        document.getElementById("loadingScreen").style.display="none";
        document.getElementById("crmSistema").style.display="block";
        listar();
        iniciarAutoRefresh();
        aplicarModoSomenteLeitura();
        
      },1500);

    }else{
      document.getElementById("erroLogin").innerText="ACESSO NEGADO";
    }

  })
  .catch(()=>{
    document.getElementById("erroLogin").innerText="Erro de conex√£o.";
  });

}




// ===============================
// üîí  PERFIL MODO SOMENTE LEITURA
// ===============================
function aplicarModoSomenteLeitura(){

  if(!SOMENTE_LEITURA) return;

  // üîí Desabilita bot√£o salvar novo lead
  const btnSalvar = document.querySelector("#formNovoLead button");
  if(btnSalvar){
    btnSalvar.disabled = true;
    btnSalvar.style.opacity = "0.5";
    btnSalvar.style.cursor = "not-allowed";
  }

  // üîí Desabilita bot√£o atualizar edi√ß√£o
  const btnAtualizar = document.querySelector("#modalEditar button");
  if(btnAtualizar){
    btnAtualizar.disabled = true;
    btnAtualizar.style.opacity = "0.5";
    btnAtualizar.style.cursor = "not-allowed";
  }

}



  

// ===============================
// üîí FILTRAR POR STATUS
// ===============================

function filtrarStatus(e, status){

  // üî• LIMPA TODOS OS FILTROS MANUAIS
  document.getElementById("filtroNome").value = "";
  document.getElementById("filtroDataInicio").value = "";
  document.getElementById("filtroDataFim").value = "";
  document.getElementById("filtroCidade").value = "";

  const filtroStatus = document.getElementById("filtroStatus");
  if(filtroStatus){
    filtroStatus.value = "";
  }

  // üî• DEFINE O STATUS DO KPI
  statusSelecionado = status;

  // üî• REMOVE DESTAQUE DE TODOS OS KPIs
  document.querySelectorAll(".kpi").forEach(k=>{
    k.classList.remove("active");
  });

  // üî• ATIVA O KPI CLICADO
  e.currentTarget.classList.add("active");

  // üî• RENDERIZA NOVAMENTE
  render();
}





// ===============================
// FUN√á√ÉO AUXILIAR PAR POPULAR O FILTRAR POR CIDADE
// ===============================

  
 function popularFiltroCidades(){

  const select = document.getElementById("filtroCidade");

  // Limpa mantendo a primeira op√ß√£o
  select.innerHTML = '<option value="">FILTRAR CIDADE</option>';

  // Pega cidades √∫nicas
  const cidadesUnicas = [...new Set(
    dadosGlobais
      .map(l => (l[5] || "").toUpperCase().trim())
      .filter(c => c !== "")
  )].sort();

  cidadesUnicas.forEach(cidade => {
    const option = document.createElement("option");
    option.value = cidade;
    option.textContent = cidade;
    select.appendChild(option);
  });
}
  




// ===============================
// FUN√á√ÉO AUXILIAR FILTRAR POR TURMA
// ===============================


function popularFiltroTurmas(){

  const select = document.getElementById("filtroTurma");

  select.innerHTML = '<option value="">FILTRAR TURMA</option>';

  const turmasUnicas = [...new Set(
    dadosGlobais
      .map(l => (l[6] || "").toUpperCase().trim())
      .filter(t => t !== "")
  )].sort();

  turmasUnicas.forEach(turma => {

    const option = document.createElement("option");
    option.value = turma;
    option.textContent = turma;

    select.appendChild(option);
  });
}
  




  


  
// ===============================
// üî¢ TELEFONE SOMENTE N√öMERO
// ===============================
document.getElementById("telefone")
.addEventListener("input", function(){
  this.value = this.value.replace(/\D/g,'');
});




  
// ===============================
// üíæ SALVAR
// ===============================
function salvar(){

  const elStatus = document.getElementById("status");

  const payload = {
    id: leadEmEdicao,
    nome: document.getElementById("nome").value.toUpperCase(),
    telefone: document.getElementById("telefone").value,
    cidade: document.getElementById("cidade").value.toUpperCase(),
    servico: document.getElementById("servico").value.toUpperCase(),
    status: elStatus ? elStatus.value : "",
    dataContato: document.getElementById("dataContato").value,
    horaContato: document.getElementById("horaContato").value,
    observacoes: document.getElementById("obs").value.toUpperCase()
  };

  console.log("PAYLOAD FINAL:", payload);

  const acao = leadEmEdicao ? "crmEditarLead" : "crmSalvarLead";

  fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      acao,
      senha:SENHA,
      payload
    })
  })
  .then(r=>r.json())
  .then(res=>{
    console.log("RESPOSTA DO SERVIDOR:", res);
    limpar();
    listar();

if(window.innerWidth <= 768){
  document.getElementById("formNovoLead").style.display = "none";
} 
  })
  .catch(err=>{
    console.error(err);
  });
}






  
// ===============================
// üì• LISTAR
// ===============================
function listar(){
  fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      acao:"crmListarLeads",
      senha:SENHA
    })
  })
  .then(r=>r.json())
  .then(res=>{

    console.log("RESPOSTA COMPLETA:", res);

    dadosGlobais = res.dados || [];

    console.log("DADOS RECEBIDOS:", dadosGlobais);

    // üî• ORDENA DO MAIS NOVO PARA O MAIS ANTIGO
    dadosGlobais.sort((a,b)=>{
      return new Date(b[1]) - new Date(a[1]);
    });

    atualizarDashboard();
    popularFiltroCidades();
    popularFiltroTurmas();
    render();

  })
  .catch(err=>{
    console.error("ERRO NO FETCH:", err);
  });
}







 // ===============================
//  FUN√á√ÉO PARA PEGAR A √öLTIMA OBSERVA√á√ÉO REGISTRADA E COLOCAR NA TELA DE CRM
// ===============================

function obterUltimaObservacao(texto){

  if(!texto) return "SEM INTERA√á√ÉO";

  // Divide por datas no formato [dd/mm/yyyy hh:mm]
  const partes = texto.split(/(?=\[\d{2}\/\d{2}\/\d{4})/g)
                      .map(p => p.trim())
                      .filter(p => p !== "");

  if(partes.length === 0) return "SEM INTERA√á√ÉO";

  const ultimoBloco = partes[partes.length - 1];

  const linhas = ultimoBloco.split("\n")
                            .map(l => l.trim())
                            .filter(l => l !== "" && !l.includes('---'));

  if(linhas.length === 0) return "SEM INTERA√á√ÉO";

  const data = linhas[0] || "";
  const conteudo = linhas[1] || "";

  let resumo = conteudo;

  if(resumo.length > 50){
    resumo = resumo.substring(0,50) + "...";
  }

  return `${data} ${resumo}`;
}




// ===============================
// INSERE ALERTA TEMPO DE ESPERA
// ===============================


function passou24h(observacoes){

  if(!observacoes) return false;

  // Pega o √∫ltimo bloco que come√ßa com [dd/mm/yyyy hh:mm]
  const partes = observacoes.split(/(?=\[\d{2}\/\d{2}\/\d{4})/g)
                            .map(p => p.trim())
                            .filter(p => p !== "");

  if(partes.length === 0) return false;

  const ultimoBloco = partes[partes.length - 1];

  // Extrai data dentro de [ ]
  const match = ultimoBloco.match(/\[(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2})\]/);

  if(!match) return false;

  const dia = match[1];
  const mes = match[2];
  const ano = match[3];
  const hora = match[4];
  const minuto = match[5];

  const dataUltima = new Date(ano, mes-1, dia, hora, minuto);
  const agora = new Date();

  const diffMs = agora - dataUltima;
  const diffHoras = diffMs / (1000 * 60 * 60);

  return diffHoras >= 24;
}



  

  


   
// ===============================
// üé® RENDER
// ===============================
function render(){

  const filtroStatus = document.getElementById("filtroStatus").value;
  const filtroNome = document.getElementById("filtroNome").value.toUpperCase();
  const filtroTelefone = document.getElementById("filtroTelefone").value.replace(/\D/g,'');
  const dataInicio = document.getElementById("filtroDataInicio").value;
  const dataFim = document.getElementById("filtroDataFim").value;
  const filtroTurma = document.getElementById("filtroTurma").value.toUpperCase();
  const filtroCidade = document.getElementById("filtroCidade").value.toUpperCase();
  

  
 

  
  let html = "";

  dadosGlobais.forEach(l=>{

    const nome = (l[3] || "").toUpperCase();
    const telefone = l[4] || "";
    const cidade = (l[5] || "").toUpperCase();
    const turma = (l[6] || "").toUpperCase(); 
    
const status = l[7] || "";
const classeStatus = status.replace(/\s/g,'-');
const data = l[1] || "";
const hora = l[2] || "";
const observacoes = l[8] || "";

let statusFinal = status;

// ‚ö†Ô∏è Aplica alerta se for EM CONTATO ou NEGOCIA√á√ÉO
if(
  (status === "EM CONTATO" || 
   status === "QUALIFICADO" ||
   status === "NEGOCIA√á√ÉO" ||
   status === "AGUARDANDO PAGAMENTO") &&
   passou24h(observacoes))

{
  
  statusFinal = "‚ö†Ô∏è " + status;
  
}


    

    const ultimaObs = obterUltimaObservacao(observacoes);

    // üî• FILTRO POR KPI (STATUS)
    if(statusSelecionado !== "TODOS" && status !== statusSelecionado) return;

    // üîé FILTRO NOME
    if(filtroNome && !nome.includes(filtroNome)) return;



    // üìû FILTRO TELEFONE
    if(filtroTelefone && !telefone.includes(filtroTelefone)) return;



    // üéì FILTRO TURMA (SERVI√áO)
   if(filtroTurma && turma !== filtroTurma) return;
    
    

    // üèôÔ∏è FILTRO CIDADE
    if(filtroCidade && !cidade.includes(filtroCidade)) return;


     // üîé FILTRO STATUS (select)
     if(filtroStatus && status !== filtroStatus) return;
    

    // üìÜ FILTRO INTERVALO DE DATA
if(dataInicio || dataFim){

  let dataLead;

  if(!data){
    return;
  }

  // üî• Se j√° for ISO ou Date v√°lido
  if(typeof data === "string" && data.includes("-")){
    dataLead = new Date(data);
  }
  // üî• Se vier DD/MM/YYYY
  else if(typeof data === "string" && data.includes("/")){
    const partes = data.split(" ")[0].split("/");
    dataLead = new Date(partes[2], partes[1]-1, partes[0]);
  }
  // üî• Se j√° for objeto Date
  else{
    dataLead = new Date(data);
  }

  if(isNaN(dataLead.getTime())) return;

  if(dataInicio){
    const inicio = new Date(dataInicio);
    inicio.setHours(0,0,0,0);
    if(dataLead < inicio) return;
  }

  if(dataFim){
    const fim = new Date(dataFim);
    fim.setHours(23,59,59,999);
    if(dataLead > fim) return;
  }
}

    html+=`
<tr>
  <td>${nome}</td>
  <td><span class="status ${classeStatus}">${statusFinal}</span></td>
  <td style="color:#aaa; font-size:12px;">${ultimaObs}</td>
  <td>
    <button ${SOMENTE_LEITURA ? 'disabled class="btn-disabled"' : ''} onclick="event.stopPropagation(); abrirWhats('${telefone}')">üí¨</button>
    
    <button onclick="event.stopPropagation(); verDetalhes('${l[0]}')">üëÅ</button>
    
    <button ${SOMENTE_LEITURA ? 'disabled class="btn-disabled"' : ''} onclick="event.stopPropagation(); abrirModalEditar('${l[0]}')">‚úèÔ∏è</button>

    <button ${SOMENTE_LEITURA ? 'disabled class="btn-delete btn-disabled"' : 'class="btn-delete"'} onclick="event.stopPropagation(); excluir('${l[0]}')">üóë</button>
    
  </td>
</tr>`;

  });

  tbody.innerHTML = html;
}




  
   

// ===============================
//  FUN√á√ÉO LIMPAR FILTROS
// ===============================

function limparFiltros(){
  document.getElementById("filtroNome").value = "";
  document.getElementById("filtroDataInicio").value = "";
  document.getElementById("filtroDataFim").value = "";
  document.getElementById("filtroCidade").value = "";
  document.getElementById("filtroStatus").value = "";
  document.getElementById("filtroTelefone").value = "";
  document.getElementById("filtroTurma").value = "";
  statusSelecionado = "TODOS";

  document.querySelectorAll(".kpi").forEach(k=>{
    k.classList.remove("active");
  });

  render();
}


   
   

// ===============================
// üì≤ WHATS
// ===============================
function abrirWhats(num){
  window.open("https://wa.me/55"+num,"_blank");
}




  
// ===============================
// üîÑ ORDENAR
// ===============================
function ordenar(col){

  dadosGlobais.sort((a,b)=>{
    return ordemAsc
      ? String(a[col]).localeCompare(String(b[col]))
      : String(b[col]).localeCompare(String(a[col]));
  });

  ordemAsc = !ordemAsc;
  render();
}





  
   
// ===============================
// ‚úè EDITAR
// ===============================
function editar(id){

  const l = dadosGlobais.find(x=>x[0]===id);
  if(!l) return;

  leadEmEdicao = id;

  nome.value = l[3] || "";
  telefone.value = l[4] || "";
  cidade.value = l[5] || "";
  servico.value = l[6] || "";
  status.value = l[7] || "";

  dataContato.value = formatarDataISO(l[1]);
  horaContato.value = formatarHoraISO(l[2]);

  obs.value = "";

  document.querySelector("button[onclick='salvar()']").innerText = "ATUALIZAR";
}






  




// ===============================
// üóëÔ∏è EXCLUIR LEAD
// ===============================
function excluir(id){

  if(!confirm("Tem certeza que deseja excluir este lead?")){
    return;
  }

  fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      acao:"crmExcluirLead",
      senha:SENHA,
      id:id
    })
  })
  .then(r=>r.json())
  .then(res=>{
    listar();
  })
  .catch(err=>{
    console.error("Erro ao excluir:", err);
  });
}








  








  

// ===============================
function limpar(){

  document.querySelectorAll("input, textarea").forEach(e=>e.value="");

  leadEmEdicao = null;

  document.querySelector("button[onclick='salvar()']").innerText = "SALVAR";
}




  

// ===============================
// ‚úè FUN√á√ÉO AUXILIAR DO EDITAR
// ===============================
  

  function formatarDataISO(data){

  if(!data) return "";

  // Se j√° estiver ISO
  if(data.includes("-")){
    return data.split("T")[0];
  }

  // Se estiver DD/MM/YYYY
  if(data.includes("/")){
    const partes = data.split(" ")[0].split("/");
    return `${partes[2]}-${partes[1]}-${partes[0]}`;
  }

  return "";
}



  // ===============================
// ‚úè FUN√á√ÉO PARA HORA
// ===============================

  

function formatarHoraISO(hora){

  if(!hora) return "";

  // Se vier formato ISO tipo 1899-12-30T12:08:00Z
  if(hora.includes("T")){
    const partes = hora.split("T")[1].split(":");
    return `${partes[0]}:${partes[1]}`;
  }

  // Se j√° estiver HH:mm
  if(hora.includes(":")){
    return hora.substring(0,5);
  }

  return "";
}




  

// ===============================
// ‚úè FUN√á√ÉO VER DETALHES DA OBERVAVA√á√ÉO DO LEAD
// ===============================
  
  

function verDetalhes(id){

  const l = dadosGlobais.find(x=>x[0]===id);

  detNome.innerText = l[3];
  detTel.innerText = l[4];
  detCidade.innerText = l[5];
  detServico.innerText = l[6] || "";
  detStatus.innerText = l[7];

  const texto = l[8] || "";

  if(!texto){
    detObs.innerText = "SEM OBSERVA√á√ïES";
  } else {

    // Divide os blocos por data
    const blocos = texto
      .split(/(?=\[\d{2}\/\d{2}\/\d{4})/g)
      .map(b => b.trim())
      .filter(b => b !== "");

    // Inverte a ordem (mais recente primeiro)
    blocos.reverse();

    // Junta novamente
    detObs.innerText = blocos.join("\n\n");
  }

  document.getElementById("modalDetalhes")
    .classList.add("active");
}






// ===============================
// ‚úè FUN√á√ÉO FECHAR MODAL
// ===============================


  function fecharModal(){
  document.getElementById("modalDetalhes")
    .classList.remove("active");
}



  


// ===============================
// ‚úè FUN√á√ÉO ATUALIZAR DASHBOARD
// ===============================

  
function atualizarDashboard(){

  let total = dadosGlobais.length;
  let lead = 0;
  let contato = 0;
  let qualificado = 0;
  let negociacao = 0;
  let maturacao = 0;
  let aguardando = 0;
  let fechados = 0;
  let perdidos = 0;
  let espera = 0;
  

  dadosGlobais.forEach(l => {

    const status = l[7];

    if(status === "LEAD") lead++;
    if(status === "EM CONTATO") contato++;
    if(status === "QUALIFICADO") qualificado++;
    if(status === "NEGOCIA√á√ÉO") negociacao++;
    if(status === "MATURA√á√ÉO DE VALOR") maturacao++;
    if(status === "AGUARDANDO PAGAMENTO") aguardando++;
    if(status === "FECHADO") fechados++;
    if(status === "PERDIDO") perdidos++;
    if(status === "LISTA DE ESPERA") espera++;
    
  });

  kpiTotal.innerText = total;
  document.getElementById("kpiLead").innerText = lead;
  kpiContato.innerText = contato;
  document.getElementById("kpiQualificado").innerText = qualificado;
  kpiNegociacao.innerText = negociacao;
  document.getElementById("kpiMaturacao").innerText = maturacao;
  document.getElementById("kpiAguardando").innerText = aguardando;
  kpiFechados.innerText = fechados;
  kpiPerdidos.innerText = perdidos;
  

  const elEspera = document.getElementById("kpiEspera");
  if(elEspera){
    elEspera.innerText = espera;
  }
}
























  function abrirModalEditar(id){

  const l = dadosGlobais.find(x=>x[0]===id);
  if(!l) return;

  idEditando = id;

  document.getElementById("editNome").value = l[3] || "";
  document.getElementById("editTelefone").value = l[4] || "";
  document.getElementById("editCidade").value = l[5] || "";
  document.getElementById("editServico").value = l[6] || "";
  document.getElementById("editStatus").value = l[7] || "";
  document.getElementById("editData").value = formatarDataISO(l[1]);
  document.getElementById("editHora").value = formatarHoraISO(l[2]);
  document.getElementById("novaObs").value = "";

  document.getElementById("modalEditar").classList.add("active");
}

function fecharModalEditar(){
  document.getElementById("modalEditar").classList.remove("active");
}

function salvarEdicao(){

  const payload = {
    id: idEditando,
    nome: document.getElementById("editNome").value.toUpperCase(),
    telefone: document.getElementById("editTelefone").value,
    cidade: document.getElementById("editCidade").value.toUpperCase(),
    servico: document.getElementById("editServico").value.toUpperCase(),
    status: document.getElementById("editStatus").value,
    dataContato: document.getElementById("editData").value,
    horaContato: document.getElementById("editHora").value,
    observacoes: document.getElementById("novaObs").value.toUpperCase()
  };

  fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      acao:"crmEditarLead",
      senha:SENHA,
      payload
    })
  })
  .then(r=>r.json())
  .then(res=>{
    fecharModalEditar();
    listar();
  });
}


  

// ===============================
// ‚úè FUN√á√ÉO AUXILIAR BOT√ÉO NOVO LEAD VER√ÉO MOBILE
// ===============================
  

 function toggleNovoLead(){

  const form = document.getElementById("formNovoLead");

  if(form.style.display === "none" || form.style.display === ""){
    form.style.display = "flex";
  } else {
    form.style.display = "none";
  }

}
  












function iniciarAutoRefresh(){

  // üî• Evita m√∫ltiplos intervalos
  if(autoRefreshInterval){
    clearInterval(autoRefreshInterval);
  }

  autoRefreshInterval = setInterval(()=>{

    const modalEditarAberto =
      document.getElementById("modalEditar").classList.contains("active");

    const modalDetalhesAberto =
      document.getElementById("modalDetalhes").classList.contains("active");

    const campoEmFoco =
      ["INPUT","TEXTAREA","SELECT"]
      .includes(document.activeElement.tagName);

    if(!modalEditarAberto && !modalDetalhesAberto && !campoEmFoco){

      console.log("üîÑ Atualiza√ß√£o autom√°tica executada");
      listar();

    } else {

      console.log("‚è∏ Atualiza√ß√£o pausada (usu√°rio editando)");

    }

  }, 60000);

}


document.addEventListener("visibilitychange", function(){

  if(document.hidden){

    if(autoRefreshInterval){
      clearInterval(autoRefreshInterval);
      autoRefreshInterval = null;
    }

    console.log("‚è∏ Auto refresh pausado (aba inativa)");

  } else {

    iniciarAutoRefresh();
    console.log("‚ñ∂ Auto refresh retomado");

  }

});
  



  




  



  


   
</script>




  
<div id="modalDetalhes" class="modal">
  <div class="modal-close" onclick="fecharModal()">FECHAR ‚úï</div>
  <h3 id="detNome"></h3>
  <p><strong>Telefone:</strong> <span id="detTel"></span></p>
  <p><strong>Cidade:</strong> <span id="detCidade"></span></p>
  <p><strong>Servi√ßo:</strong> <span id="detServico"></span></p>
  <p><strong>Status:</strong> <span id="detStatus"></span></p>
  <hr>
  <h4>HIST√ìRICO DE ATENDIMENTO</h4>
  <div id="detObs" style="white-space:pre-wrap; font-size:13px;"></div>
</div>





  


  <div id="modalEditar" class="modal">
  <div class="modal-close" onclick="fecharModalEditar()">FECHAR ‚úï</div>
  <h3>EDITAR LEAD</h3>

  <div class="form-group">
  <label>Nome</label>
  <input id="editNome">
</div>

<div class="form-group">
  <label>Telefone</label>
  <input id="editTelefone">
</div>

<div class="form-group">
  <label>Cidade</label>
  <input id="editCidade">
</div>

<div class="form-group">
  <label>Servi√ßo</label>
  <input id="editServico">
</div>

<div class="form-group">
  <label>Status</label>
  <select id="editStatus">
    <option>LEAD</option>
    <option>EM CONTATO</option>
    <option>QUALIFICADO</option>
    <option>NEGOCIA√á√ÉO</option>
    <option>MATURA√á√ÉO DE VALOR</option>
    <option>AGUARDANDO PAGAMENTO</option>
    <option>FECHADO</option>
    <option>PERDIDO</option>
    <option>LISTA DE ESPERA</option>
  </select>
</div>

<div class="form-group">
  <label>Data do Contato</label>
  <input type="date" id="editData">
</div>

<div class="form-group">
  <label>Hora do Contato</label>
  <input type="time" id="editHora">
</div>

<div class="form-group">
  <label>Nova Observa√ß√£o</label>
  <textarea id="novaObs"
            rows="5"
            style="resize:vertical;"></textarea>
</div>
  <br><br>
  <button onclick="salvarEdicao()">ATUALIZAR</button>
</div>


  

 </div>  
</body>
</html>
