<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CRM LEADS</title>

<style>
body {
  background:#000;
  color:#fff;
  font-family:Arial;
}
input, select, textarea {
  padding:6px;
  margin:3px;
}
button {
  padding:6px 10px;
  cursor:pointer;
}
</style>

</head>
<body>

<h2>GESTÃƒO DE LEADS</h2>

<div id="loginBox">
  <input type="password" id="senha" placeholder="SENHA">
  <button onclick="login()">ENTRAR</button>
</div>

<div id="crmBox" style="display:none">

<input type="hidden" id="leadId">

<input id="nome" placeholder="NOME">
<input id="telefone" placeholder="TELEFONE">
<input id="cidade" placeholder="CIDADE">
<input id="servico" placeholder="SERVIÃ‡O">
<select id="status">
  <option>LEAD</option>
  <option>EM CONTATO</option>
  <option>NEGOCIAÃ‡ÃƒO</option>
  <option>FECHADO</option>
  <option>PERDIDO</option>
</select>

<input type="date" id="dataContato">
<input type="time" id="horaContato">

<textarea id="obs" placeholder="OBSERVAÃ‡Ã•ES"></textarea>

<button onclick="salvar()">SALVAR</button>

<hr>

<input id="filtroNome" placeholder="BUSCAR NOME" onkeyup="listar()">

<div id="lista"></div>

</div>

<script>

const ENDPOINT = "COLE_AQUI_SEU_ENDPOINT";

let SENHA_GLOBAL = "";

function login() {

  SENHA_GLOBAL = document.getElementById("senha").value;

  fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      acao:"crmListarLeads",
      senha:SENHA_GLOBAL
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.sucesso){
      document.getElementById("loginBox").style.display="none";
      document.getElementById("crmBox").style.display="block";
      listar();
    } else {
      alert("Senha invÃ¡lida");
    }
  });
}

function salvar(){

  const payload = {
    id: document.getElementById("leadId").value,
    nome: document.getElementById("nome").value.toUpperCase(),
    telefone: document.getElementById("telefone").value,
    cidade: document.getElementById("cidade").value.toUpperCase(),
    servico: document.getElementById("servico").value.toUpperCase(),
    status: document.getElementById("status").value,
    dataContato: document.getElementById("dataContato").value,
    horaContato: document.getElementById("horaContato").value,
    observacoes: document.getElementById("obs").value
  };

  fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      acao: payload.id ? "crmEditarLead":"crmSalvarLead",
      senha:SENHA_GLOBAL,
      payload:payload
    })
  })
  .then(r=>r.json())
  .then(()=>{
    alert("SALVO");
    listar();
  });
}

function listar(){

  fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      acao:"crmListarLeads",
      senha:SENHA_GLOBAL
    })
  })
  .then(r=>r.json())
  .then(res=>{

    let html="<table border=1>";

    const filtro = document
      .getElementById("filtroNome")
      .value
      .toUpperCase();

    res.dados.forEach(l=>{

      if(!l[3].includes(filtro)) return;

      html+=`
      <tr>
        <td>${l[3]}</td>
        <td>${l[4]}</td>
        <td>${l[7]}</td>
        <td>
          <button onclick="abrirWhats('${l[4]}')">ðŸ’¬</button>
        </td>
      </tr>`;
    });

    html+="</table>";

    document.getElementById("lista").innerHTML=html;
  });
}

function abrirWhats(numero){
  const n = numero.replace(/\D/g,'');
  window.open("https://wa.me/55"+n,"_blank");
}

</script>

</body>
</html>
