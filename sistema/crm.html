<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">   
<meta charset="UTF-8">
<title>CRM LEADS WHTASAPP</title>

<style>

html, body{
  overflow-x:hidden;
}

   
/* ===============================
   üî• BASE VISUAL PROFISSIONAL
================================ */
body{
  background:#0f0f0f;
  color:#fff;
  font-family:Segoe UI, Arial;
  margin:0;
}

header{
  padding:20px;
  font-size:22px;
  font-weight:600;
  letter-spacing:1px;
  border-bottom:1px solid #222;
}

.container{
  padding:20px 30px;
}

/* ===============================
   üîπ FORM CARD
================================ */
.card{
  background:#181818;
  padding:20px;
  border-radius:8px;
  box-shadow:0 0 10px rgba(0,0,0,.4);
  margin-bottom:20px;
}

.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

input, select, textarea{
  background:#111;
  border:1px solid #333;
  color:#fff;
  padding:8px;
  border-radius:5px;
  outline:none;
  font-size:13px;
}

input:focus, select:focus, textarea:focus{
  border:1px solid #00bfff;
}

input{
  text-transform:uppercase;
}

textarea{
  resize:none;
}

button{
  background:#00bfff;
  border:none;
  padding:9px 14px;
  border-radius:5px;
  cursor:pointer;
  font-weight:600;
  font-size:12px;
}

button:hover{
  background:#009acd;
}

.btn-secondary{
  background:#333;
}

.btn-secondary:hover{
  background:#444;
}


   
/* ===============================
   üîπ TABELA CRM
================================ */
.table{
  width:100%;
  border-collapse:collapse;
}

.table th{
  background:#1e1e1e;
  padding:10px;
  text-align:left;
  font-size:12px;
  letter-spacing:.5px;
  cursor:pointer;
}

.table td{
  padding:10px;
  border-bottom:1px solid #222;
  font-size:13px;
}

.table tr:hover{
  background:#1a1a1a;
}

.status{
  padding:4px 8px;
  border-radius:12px;
  font-size:11px;
  font-weight:bold;
}

.LEAD{background:#555;}
.EM\ CONTATO{background:#0066cc;}
.NEGOCIA√á√ÉO{background:#ff9900;}
.FECHADO{background:#00aa55;}
.PERDIDO{background:#aa0000;}

.search-box{
  margin-bottom:10px;
}



/* ===============================
   üî• MODAL DETALHES
================================ */
.modal{
  position:fixed;
  top:0;
  right:0;
  width:450px;
  height:100%;
  background:#121212;
  box-shadow:-3px 0 10px rgba(0,0,0,.5);
  padding:25px;
  overflow-y:auto;
  transform:translateX(110%);
  transition:transform .3s ease;
  z-index:999;
}

.modal.active{
  transform:translateX(0);
}

.modal h3{
  margin-top:0;
}

.modal-close{
  cursor:pointer;
  color:#00bfff;
  font-size:12px;
}




/* ===============================
   üìä DASHBOARD CRM
================================ */
.dashboard{
  display:flex;
  gap:15px;
  margin-bottom:20px;
  flex-wrap:wrap;
}

.kpi{
  flex:1;
  min-width:150px;
  background:#181818;
  padding:15px;
  border-radius:8px;
  text-align:center;
  box-shadow:0 0 10px rgba(0,0,0,.3);
}

.kpi h4{
  margin:0;
  font-size:12px;
  letter-spacing:.5px;
  color:#aaa;
}

.kpi span{
  display:block;
  font-size:22px;
  margin-top:5px;
  font-weight:bold;
}
   
   

.kpi{ cursor:pointer; transition:.2s; }
.kpi:hover{ transform:scale(1.05); }

.kpi-total{ background:#2b2b2b; }
.kpi-contato{ background:#004c99; }
.kpi-negociacao{ background:#cc8400; }
.kpi-fechado{ background:#006633; }
.kpi-perdido{ background:#660000; }

.kpi.active{
  outline:2px solid #00bfff;
}
   



   /* ===============================
   RESPONSIVIDADE TELA CELULAR
================================ */
   
@media(max-width:768px){

  body{
    font-size:15px;
  }

  .container{
    padding:15px;
  }

  .dashboard{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }

  .kpi{
    min-width:auto;
    padding:12px;
  }

  .card{
    padding:15px;
  }

  .row{
    flex-direction:column;
    gap:12px;
  }

  input, select, textarea{
    font-size:15px;
    padding:12px;
  }

  button{
    width:100%;
    padding:14px;
    font-size:14px;
  }

  .table{
    font-size:13px;
  }

  header{
    font-size:18px;
    text-align:center;
  }

   input, select, textarea {
  width: 100%;
  box-sizing: border-box;
}


 .modal{
  width:100%;
  padding:20px;
}

}


   

   
</style>
</head>
<body>

<header>GEST√ÉO DE LEADS</header>


<div class="container">

<div class="dashboard">

  <div class="kpi kpi-total" onclick="filtrarStatus(event,'TODOS')">
    <h4>TOTAL</h4>
    <span id="kpiTotal">0</span>
  </div>

  <div class="kpi kpi-contato" onclick="filtrarStatus(event,'EM CONTATO')">
    <h4>EM CONTATO</h4>
    <span id="kpiContato">0</span>
  </div>

  <div class="kpi kpi-negociacao" onclick="filtrarStatus(event,'NEGOCIA√á√ÉO')">
    <h4>NEGOCIA√á√ÉO</h4>
    <span id="kpiNegociacao">0</span>
  </div>

  <div class="kpi kpi-fechado" onclick="filtrarStatus(event,'FECHADO')">
    <h4>FECHADOS</h4>
    <span id="kpiFechados">0</span>
  </div>

  <div class="kpi kpi-perdido" onclick="filtrarStatus(event,'PERDIDO')">
    <h4>PERDIDOS</h4>
    <span id="kpiPerdidos">0</span>
  </div>

</div>
   


<div class="card">

<div class="row">

<input id="nome" placeholder="NOME">
<input id="telefone" placeholder="TELEFONE">
<input id="cidade" placeholder="CIDADE">
<input id="servico" placeholder="SERVI√áO">

<select id="status">
  <option>LEAD</option>
  <option>EM CONTATO</option>
  <option>NEGOCIA√á√ÉO</option>
  <option>FECHADO</option>
  <option>PERDIDO</option>
</select>

<input type="text" id="dataContato" placeholder="INSERIR DATA"
       onfocus="this.type='date'"
       onblur="if(!this.value)this.type='text'">

<input type="text" id="horaContato" placeholder="INSERIR HORA"
       onfocus="this.type='time'"
       onblur="if(!this.value)this.type='text'">

  
<textarea id="obs" placeholder="OBSERVA√á√ïES" rows="2"></textarea>

<button onclick="salvar()">SALVAR</button>
<button class="btn-secondary" onclick="limpar()">NOVO</button>

</div>
</div>

<div class="card">

<div class="search-box row">

<input id="filtroNome" placeholder="BUSCAR NOME" onkeyup="render()">

<input type="text" id="filtroDataInicio" placeholder="SELECIONE DATA IN√çCIO"
       onfocus="this.type='date'"
       onblur="if(!this.value)this.type='text'"
       onchange="render()">

<input type="text" id="filtroDataFim" placeholder="SELECIONE DATA FIM"
       onfocus="this.type='date'"
       onblur="if(!this.value)this.type='text'"
       onchange="render()">

<input id="filtroCidade" placeholder="FILTRAR CIDADE" onkeyup="render()">

<button class="btn-secondary" onclick="limparFiltros()">LIMPAR FILTROS</button>

</div>

<table class="table">
<thead>
<tr>
<th onclick="ordenar(3)">NOME</th>
<th onclick="ordenar(4)">TELEFONE</th>
<th onclick="ordenar(5)">CIDADE</th>
<th onclick="ordenar(7)">STATUS</th>
<th>A√á√ïES</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

</div>

<script>

const ENDPOINT = "https://script.google.com/macros/s/AKfycbw5-8ipl32njS9C5YKp67i2eQJWDoAfrShx3p4IAtDzayVlaIyuztlNMeoF2a3-aAqf/exec";

let SENHA = "";
let dadosGlobais = [];
let ordemAsc = true;
let statusSelecionado = "TODOS";
   

// ===============================
// üîí LOGIN AUTOM√ÅTICO
// ===============================
window.onload = function(){
  SENHA = prompt("DIGITE SUA SENHA");
  listar();
};


   


// ===============================
// üîí FILTRAR POR STATUS
// ===============================

function filtrarStatus(e, status){

  statusSelecionado = status;

  document.querySelectorAll(".kpi").forEach(k=>{
    k.classList.remove("active");
  });

  e.currentTarget.classList.add("active");

  render();
}



   



  
// ===============================
// üî¢ TELEFONE SOMENTE N√öMERO
// ===============================
document.getElementById("telefone")
.addEventListener("input", function(){
  this.value = this.value.replace(/\D/g,'');
});

// ===============================
// üíæ SALVAR
// ===============================
function salvar(){

  const payload = {
    nome: nome.value,
    telefone: telefone.value,
    cidade: cidade.value,
    servico: servico.value,
    status: status.value,
    dataContato: dataContato.value,
    horaContato: horaContato.value,
    observacoes: obs.value
  };

  console.log("üîç PAYLOAD ENVIADO:", payload);

  fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      acao:"crmSalvarLead",
      senha:SENHA,
      payload
    })
  })
  .then(r=>r.json())
  .then(res=>{
    console.log("‚úÖ RESPOSTA DO SERVIDOR:", res);
    limpar();
    listar();
  })
  .catch(err=>{
    console.error("‚ùå ERRO NO SALVAR:", err);
  });
}


// ===============================
// üì• LISTAR
// ===============================
function listar(){
  fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      acao:"crmListarLeads",
      senha:SENHA
    })
  })
  .then(r=>r.json())
  .then(res=>{

    console.log("RESPOSTA COMPLETA:", res);

    dadosGlobais = res.dados || [];

    console.log("DADOS RECEBIDOS:", dadosGlobais);

    // üî• ORDENA DO MAIS NOVO PARA O MAIS ANTIGO
    dadosGlobais.sort((a,b)=>{
      return new Date(b[1]) - new Date(a[1]);
    });

    atualizarDashboard();
    render();

  })
  .catch(err=>{
    console.error("ERRO NO FETCH:", err);
  });
}
















   
// ===============================
// üé® RENDER
// ===============================
function render(){

  const filtroNome = document.getElementById("filtroNome").value.toUpperCase();
  const dataInicio = document.getElementById("filtroDataInicio").value;
  const dataFim = document.getElementById("filtroDataFim").value;
  const filtroCidade = document.getElementById("filtroCidade").value.toUpperCase();

  let html = "";

  dadosGlobais.forEach(l=>{

    const nome = (l[3] || "").toUpperCase();
    const telefone = l[4] || "";
    const cidade = (l[5] || "").toUpperCase();
    const status = l[7] || "";
    const data = l[1] || "";
    const hora = l[2] || "";

// üî• FILTRO POR KPI (STATUS)
  if(statusSelecionado !== "TODOS" && status !== statusSelecionado) return;

     
    // üîé FILTRO NOME
    if(filtroNome && !nome.includes(filtroNome)) return;

    // üèôÔ∏è FILTRO CIDADE
    if(filtroCidade && !cidade.includes(filtroCidade)) return;

    // üìÜ FILTRO INTERVALO DE DATA
if(dataInicio || dataFim){

  // converte formato DD/MM/YYYY HH:MM:SS para objeto Date v√°lido
let partes = data.split(" ")[0].split("/");
let dataLead = new Date(partes[2], partes[1]-1, partes[0]);

  if(dataInicio){
    const inicio = new Date(dataInicio);
    if(dataLead < inicio) return;
  }

  if(dataFim){
    const fim = new Date(dataFim);
    fim.setHours(23,59,59,999);
    if(dataLead > fim) return;
  }
}

    

    html+=`
    <tr onclick="editar('${l[0]}')">
      <td>${nome}</td>
      <td>${telefone}</td>
      <td>${cidade}</td>
      <td><span class="status ${status}">${status}</span></td>
      <td>
        <button onclick="event.stopPropagation(); abrirWhats('${telefone}')">üí¨</button>
        <button onclick="event.stopPropagation(); verDetalhes('${l[0]}')">üëÅ</button>
      </td>
    </tr>`;
  });

  tbody.innerHTML = html;
}



   

// ===============================
//  FUN√á√ÉO LIMPAR FILTROS
// ===============================

function limparFiltros(){
  document.getElementById("filtroNome").value = "";
  document.getElementById("filtroDataInicio").value = "";
  document.getElementById("filtroDataFim").value = "";
  document.getElementById("filtroCidade").value = "";
  statusSelecionado = "TODOS";

  document.querySelectorAll(".kpi").forEach(k=>{
    k.classList.remove("active");
  });

  render();
}


   
   

// ===============================
// üì≤ WHATS
// ===============================
function abrirWhats(num){
  window.open("https://wa.me/55"+num,"_blank");
}

// ===============================
// üîÑ ORDENAR
// ===============================
function ordenar(col){

  dadosGlobais.sort((a,b)=>{
    return ordemAsc
      ? String(a[col]).localeCompare(String(b[col]))
      : String(b[col]).localeCompare(String(a[col]));
  });

  ordemAsc = !ordemAsc;
  render();
}


   
// ===============================
// ‚úè EDITAR
// ===============================
function editar(id){

  const l = dadosGlobais.find(x=>x[0]===id);

  nome.value = l[3];
  telefone.value = l[4];
  cidade.value = l[5];
  servico.value = l[6];
  status.value = l[7];
  dataContato.value = l[1];
  horaContato.value = l[2];
}

// ===============================
function limpar(){
  document.querySelectorAll("input, textarea").forEach(e=>e.value="");
}



function verDetalhes(id){

  const l = dadosGlobais.find(x=>x[0]===id);

  detNome.innerText = l[3];
  detTel.innerText = l[4];
  detCidade.innerText = l[5];
  detStatus.innerText = l[7];
  detObs.innerText = l[8] || "SEM OBSERVA√á√ïES";

  document.getElementById("modalDetalhes")
    .classList.add("active");
}

function fecharModal(){
  document.getElementById("modalDetalhes")
    .classList.remove("active");
}





function atualizarDashboard(){

  let total = dadosGlobais.length;
  let contato = 0;
  let negociacao = 0;
  let fechados = 0;
  let perdidos = 0;

  dadosGlobais.forEach(l => {

    const status = l[7];

    if(status === "EM CONTATO") contato++;
    if(status === "NEGOCIA√á√ÉO") negociacao++;
    if(status === "FECHADO") fechados++;
    if(status === "PERDIDO") perdidos++;
  });

  kpiTotal.innerText = total;
  kpiContato.innerText = contato;
  kpiNegociacao.innerText = negociacao;
  kpiFechados.innerText = fechados;
  kpiPerdidos.innerText = perdidos;
}






   



   
</script>


<div id="modalDetalhes" class="modal">
  <div class="modal-close" onclick="fecharModal()">FECHAR ‚úï</div>
  <h3 id="detNome"></h3>
  <p><strong>Telefone:</strong> <span id="detTel"></span></p>
  <p><strong>Cidade:</strong> <span id="detCidade"></span></p>
  <p><strong>Status:</strong> <span id="detStatus"></span></p>
  <hr>
  <h4>HIST√ìRICO DE ATENDIMENTO</h4>
  <div id="detObs" style="white-space:pre-wrap; font-size:13px;"></div>
</div>



   
</body>
</html>
