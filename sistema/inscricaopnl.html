<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pr√©-inscri√ß√£o</title>

<style>
* { box-sizing: border-box; }

body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
}

.card {
  display: none;
  background: #fff;
  padding: 25px;
  max-width: 420px;
  width: 100%;
  border-radius: 12px;
  box-shadow: 0 8px 20px rgba(0,0,0,.1);
}

.loader {
  font-size: 18px;
  color: #1f3c88;
}

input, select, button {
  width: 100%;
  padding: 14px;
  margin-bottom: 12px;
  border-radius: 10px;
  border: 1px solid #ccc;
}

input.erro {
  border-color: red;
}

button {
  background: linear-gradient(135deg, #1f3c88, #2f55d4);
  color: #fff;
  border: none;
  font-weight: bold;
  cursor: pointer;
}

button:disabled {
  opacity: .6;
  cursor: not-allowed;
}
</style>
</head>

<body>

<div class="loader" id="loader">
  üîé Validando link de inscri√ß√£o‚Ä¶
</div>

<div class="card" id="formCard">

  <h2 id="titulo"></h2>

  <input id="nome" placeholder="Seu nome completo">
  <input id="cpf" placeholder="CPF (somente n√∫meros)">
  <input id="email" placeholder="Seu melhor e-mail">
  <input id="telefone" placeholder="Telefone / WhatsApp">

  <select id="pais">
    <option value="">Pa√≠s</option>
    <option value="BR">Brasil</option>
    <option value="JP">Jap√£o</option>
    <option value="PY">Paraguai</option>
  </select>

  <select id="estado" disabled>
    <option value="">Estado / Regi√£o</option>
  </select>

  <input id="estadoOutro" placeholder="Digite o estado / regi√£o" style="display:none">

  <select id="cidade" disabled>
    <option value="">Cidade</option>
  </select>

  <input id="cidadeOutra" placeholder="Digite a cidade" style="display:none">

  <button id="btnConfirmar" onclick="finalizar()">
    CONFIRMAR PR√â-INSCRI√á√ÉO
  </button>

</div>

<script src="/js/localidades.js"></script>
<script src="/js/igc-config.js"></script>

<script>
const params = new URLSearchParams(location.search);
const TOKEN = params.get("token");

if (!TOKEN) {
  document.body.innerHTML = "<h2>Link inv√°lido ou expirado.</h2>";
}

let ENDPOINT = "";
let NOME_CURSO = "";
let CARGA_HORARIA = "";
let LOCAL_CURSO = "";
let DATA_HORARIO_CURSO = "";
let TURMA = "";

// üîπ Valida token
fetch(`${window.IGC_CONFIG.APPS_SCRIPT_BASE}?token=${TOKEN}`)
  .then(r => r.json())
  .then(data => {

    if (!data.sucesso) {
      document.body.innerHTML = "<h2>Link inv√°lido ou expirado.</h2>";
      return;
    }

    NOME_CURSO = data.nomeCurso;
    CARGA_HORARIA = data.cargaHoraria;
    LOCAL_CURSO = data.localCurso;
    DATA_HORARIO_CURSO = data.dataHorarioCurso;
    TURMA = data.turma;
    ENDPOINT = data.endpoint;

    document.getElementById("titulo").innerText =
      `Pr√©-inscri√ß√£o ‚Äì ${NOME_CURSO}`;

    document.getElementById("loader").style.display = "none";
    document.getElementById("formCard").style.display = "block";
  })
  .catch(() => {
    document.body.innerHTML =
      "<h2>Erro ao validar o link. Tente novamente.</h2>";
  });

const nomeEl = document.getElementById("nome");
const cpfEl = document.getElementById("cpf");
const emailEl = document.getElementById("email");
const telefoneEl = document.getElementById("telefone");
const paisEl = document.getElementById("pais");
const estadoEl = document.getElementById("estado");
const cidadeEl = document.getElementById("cidade");
const estadoOutroEl = document.getElementById("estadoOutro");
const cidadeOutraEl = document.getElementById("cidadeOutra");
const btnConfirmar = document.getElementById("btnConfirmar");

nomeEl.oninput = e => e.target.value =
  e.target.value.replace(/[^A-Za-z√Ä-√ø ]/g,'').toUpperCase();

telefoneEl.oninput = e =>
  e.target.value = e.target.value.replace(/\D/g,'');

cpfEl.oninput = e =>
  e.target.value = e.target.value.replace(/\D/g,'').slice(0,11);

emailEl.oninput = e =>
  e.target.value = e.target.value.toLowerCase();

function finalizar() {

  if (!nomeEl.value.trim()) return alert("Informe o nome.");
  if (!emailEl.value.trim()) return alert("Informe o e-mail.");
  if (!telefoneEl.value.trim()) return alert("Informe o telefone.");
  if (!paisEl.value) return alert("Selecione o pa√≠s.");

  btnConfirmar.disabled = true;
  btnConfirmar.innerText = "Registrando pr√©-inscri√ß√£o...";

  fetch(ENDPOINT, {
    method: "POST",
    body: JSON.stringify({

      // üîπ CHAVE DA BIFURCA√á√ÉO
      tipo: "PRE",

      token: TOKEN,
      nome: nomeEl.value,
      cpf: cpfEl.value,
      email: emailEl.value,
      telefone: telefoneEl.value,
      cidade: cidadeEl.value === "OUTRA"
        ? cidadeOutraEl.value
        : cidadeEl.value,
      estado: estadoEl.value === "OUTRO"
        ? estadoOutroEl.value
        : estadoEl.value,

      nomeCurso: NOME_CURSO,
      cargaHoraria: CARGA_HORARIA,
      localCurso: LOCAL_CURSO,
      dataHorarioCurso: DATA_HORARIO_CURSO,
      turma: TURMA
    })
  })
  .then(r => r.json())
  .then(res => {

    if (!res.sucesso) {
      alert("Erro ao registrar a pr√©-inscri√ß√£o.");
      btnConfirmar.disabled = false;
      btnConfirmar.innerText = "CONFIRMAR PR√â-INSCRI√á√ÉO";
      return;
    }

    document.body.innerHTML = `
      <div style="
        background:#f4f6f8;
        min-height:100vh;
        display:flex;
        align-items:center;
        justify-content:center;
        padding:20px;
        text-align:center;
      ">
        <div style="
          background:#fff;
          padding:30px;
          border-radius:12px;
          max-width:420px;
          box-shadow:0 8px 20px rgba(0,0,0,.1);
        ">
          <h2 style="color:#1f3c88;">üìù Pr√©-inscri√ß√£o realizada!</h2>
          <p style="margin-top:15px;">
            Recebemos seus dados com sucesso.<br><br>
            Para confirmar sua vaga, finalize o pagamento conforme instru√ß√µes
            recebidas.
          </p>
          <p style="margin-top:20px;">
            Ap√≥s a confirma√ß√£o do pagamento, voc√™ receber√° automaticamente
            todas as informa√ß√µes e materiais no e-mail.
          </p>
        </div>
      </div>
    `;
  });
}
</script>

</body>
</html>
