<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Cadastro de Cursos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * { box-sizing: border-box; }

    html {
  height: 100%;
  background: linear-gradient(180deg, #020617, #0f172a);
}

body {
  min-height: 100%;
  margin: 0;
  padding: 16px;
  font-family: Arial, Helvetica, sans-serif;
  color: #e5e7eb;
  background: transparent;
}

    .container {
      max-width: min(1600px, 95vw);
      margin: 0 auto;
      padding: 24px;
      background: #020617;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0,0,0,.4);
    }

    h1 {
      margin: 0 0 20px 0;
      font-size: 22px;
    }

    .nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .nav button {
      width: auto;
      padding: 8px 14px;
    }

    .counter {
      font-size: 14px;
      opacity: .8;
    }

    input, textarea, select, button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
    }

    input, textarea, select {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #334155;
    }

    textarea { min-height: 80px; resize: vertical; }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 24px;
    }

    .actions button {
      height: 40px;
    }


    .field {
  margin-top: 14px;
}

.field label {
  display: block;
  font-size: 13px;
  margin-bottom: 4px;
  opacity: 0.85;
}

.bottom-nav {
  margin-top: 30px;
  margin-bottom: 10px;
}

.btn-novo    { background: #fff; }
.btn-editar  { background: #eab308; color: #000; }
.btn-salvar  { background: #16a34a; }
.btn-login   { background: #2563eb; }
.secondary   { background: #ff8c00; }   

button {
  transition: transform .1s ease, box-shadow .1s ease, opacity .1s ease;
}

button:active {
  transform: scale(0.97);
  box-shadow: 0 0 0 rgba(0,0,0,0);
  opacity: 0.9;
}

button:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}
 

    .danger { background: #dc2626; }
    
    .hidden { display: none; }

    @media (max-width: 768px) {
      .row { grid-template-columns: 1fr; }
      .actions { flex-direction: column; }
    }

.uppercase {
  text-transform: uppercase;
}





#loadingBox,
#appBox {
  display: none;
}

#loadingBox {
  position: fixed;
  inset: 0;
  background: linear-gradient(180deg, #020617, #0f172a);
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  text-align: center;
}


/* =========================
   LAYOUT DESKTOP OTIMIZADO
   ========================= */
@media (min-width: 1200px) {

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px 24px;
  }

  /* Campos que ocupam linha inteira */
  .span-2 {
    grid-column: span 2;
  }

  /* Reduz espa√ßamento vertical */
  .field {
    margin-top: 8px;
  }

  textarea {
    min-height: 60px;
  }
}



/* =======================
   MODAL OVERLAY
======================= */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(2, 6, 23, 0.85);
  z-index: 99999;

  display: none;

  overflow-y: auto;                 /* ‚úÖ SCROLL AQUI */
  -webkit-overflow-scrolling: touch;

  padding: 20px 12px;               /* espa√ßo p/ respirar */
}

.modal-overlay.aberto {
  display: block;
}

.modal-box {
  width: 100%;
  max-width: 720px;

  margin: 0 auto 40px auto;          /* empurra p/ baixo */

  background: #020617;
  border-radius: 14px;
  box-shadow: 0 30px 80px rgba(0,0,0,.6);

  overflow: visible;                 /* ‚ùó N√ÉO rola */
}

/* HEADER */
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 20px;
  border-bottom: 1px solid #334155;
}

.modal-header {
  padding: 18px 20px 12px;
  border-bottom: 1px solid #1e293b;
}


.modal-header h2 {
  margin: 0;
  font-size: 17px;
  font-weight: 600;
  color: #e5e7eb;
}
    

.modal-close {
  background: transparent;
  border: none;
  font-size: 26px;
  color: #94a3b8;
  cursor: pointer;
}

.modal-close:hover {
  color: #f87171;
}

/* CONTENT */
.modal-content {
  padding: 16px;
  overflow: visible;
}
    
/* TABLE */
.modal-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.modal-table th {
  text-align: left;
  padding: 10px;
  border-bottom: 1px solid #334155;
  color: #94a3b8;
}

.modal-table td {
  padding: 10px;
  vertical-align: top;
  border-bottom: 1px solid #1e293b;
  word-break: break-all;
}

/* ACTION BUTTONS */
.acoes {
  display: flex;
  gap: 6px;
}

.btn-id {
  background: #2563eb;
  color: #fff;
}

.btn-id:hover {
  background: #1d4ed8;
}

.btn-url:hover {
  background: #15803d;
}    

.btn-url {
  background: #16a34a;
  color: #fff;
}

.btn-id,
.btn-url {
  border: none;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
}

/* FOOTER */
.modal-footer {
  padding: 12px 16px;
  border-top: 1px solid #1e293b;
  display: flex;
  justify-content: flex-end;
}

.btn-fechar {
  width: auto;
  padding: 8px 18px;
  background: transparent;
  border: 1px solid #334155;
  color: #cbd5f5;
  border-radius: 8px;
  font-size: 13px;
}

/* MOBILE */
@media (max-width: 600px) {
  .modal-box {
    width: 94vw;
    max-height: 90vh;
  }

  .modal-table tr {
    padding: 10px 0;
  }

  .modal-table td {
    font-size: 12px;
  }

  .acoes {
    justify-content: flex-start;
  }
}



/* ===== MODAL MODELOS (UX) ===== */

.modal-modelos {
  max-width: 720px;
}

.lista-modelos {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.modelo-card {
  border: 1px solid #1e293b;
  border-radius: 10px;
  padding: 14px;
  background: #020617;
}

.modelo-nome {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 10px;
}

.modelo-acoes {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.modelo-acoes button {
  flex: 1;
  padding: 10px;
  font-size: 13px;
}

/* MOBILE */
@media (max-width: 600px) {
  .modelo-acoes {
    flex-direction: column;
  }

  .modelo-acoes button {
    width: 100%;
  }
}



.modal-header {
  justify-content: center;
  text-align: center;
}

.modal-header h2 {
  width: 100%;
  text-align: center;
}

/* bot√£o remover QR */
.btn-remover {
  background: #dc2626;
  color: #fff;
}

.btn-remover:hover {
  background: #b91c1c;
}


/* ===== STATUS QR CODE ===== */

.modelo-card.com-qr {
  border-color: #16a34a;
  box-shadow: 0 0 0 1px rgba(22,163,74,.4);
}

.status-qrcode {
  font-size: 12px;
  color: #16a34a;
  margin-bottom: 8px;
}

.hidden-input {
  display: none;
}    



.preview-box {
  width: 180px;
  height: 110px;
  border: 1px solid #334155;
  border-radius: 8px;
  overflow: hidden;
  background: #020617;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
}

.preview-box iframe {
  width: 800px;
  height: 500px;
  border: none;
  transform: scale(0.22);
  transform-origin: top left;
  pointer-events: none; /* n√£o interage dentro */
}

/* mobile */
@media (max-width: 768px) {
  .preview-box {
    width: 100%;
    height: 120px;
  }
}


/* container do preview */
.preview-wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 140px;
}

/* melhora visual do box */
.preview-box {
  width: 200px;
  height: 120px;
  border: 1px solid #334155;
  border-radius: 10px;
  overflow: hidden;
  background: #020617;
  box-shadow: 0 10px 25px rgba(0,0,0,.35);
}

/* üîí trava scroll do body quando modal aberto */
body.modal-open {
  overflow: hidden;
  touch-action: none;
} 

    @media (max-width: 768px) {
  .modal-overlay {
    align-items: flex-start;
    padding-top: 12px;
    padding-bottom: 12px;
  }
    }
    
  </style>
</head>

<body>

<script src="/js/igc-config.js"></script>

<!-- üîê LOGIN -->
<div id="loginBox" class="container">
  <h1>Acesso Restrito</h1>

  <div class="field">
    <label>Senha de acesso</label>
    <input type="password" id="senhaLogin">
  </div>

  <button class="btn-login" onclick="login()">Entrar</button>
  <p id="loginErro" style="color:#f87171; margin-top:10px;"></p>
</div>

<!-- ‚è≥ LOADING (FULLSCREEN) -->
<div id="loadingBox">
  <h1>IGC Treinamentos Corporativo</h1>
  <p>Carregando sistema...</p>
</div>

<!-- üìã SISTEMA -->
<div id="appBox" class="container">
  <h1>Cadastro de Cursos</h1>
  

<!-- üîç FILTRO DE CURSOS -->
<div class="row" style="margin-bottom:20px;">
  <div class="field">
    <label>Filtrar por curso</label>
    <input
  id="filtroCurso"
  class="no-lock"
  placeholder="Digite parte do nome do curso"
  oninput="aplicarFiltro()"
>
  </div>

  <div class="field">
    <label>Filtrar por turma</label>
    <input
  id="filtroTurma"
  class="no-lock"
  placeholder="Ex: TURMA A, MANH√É, NOITE"
  oninput="aplicarFiltro()"
>
  </div>
</div>


  

  <!-- FORM -->
<input type="hidden" id="cursoId">

<div class="form-grid">

  <div class="field">
    <label>Nome do curso</label>
    <input id="nome" disabled class="uppercase">
  </div>

  <div class="field">
    <label>Turma</label>
    <input id="turma" disabled class="uppercase" onblur="validarTurma()">
  </div>

  <div class="field">
    <label>Carga hor√°ria</label>
    <input
      id="carga"
      disabled
      inputmode="numeric"
      pattern="[0-9]*"
      oninput="somenteNumeros(this)"
    >
  </div>

  <div class="field">
    <label>Status</label>
    <select id="ativo" disabled>
      <option value="TRUE">Ativo</option>
      <option value="FALSE">Inativo</option>
    </select>
  </div>

  <div class="field span-2">
    <label>Local</label>
    <input id="local" disabled class="uppercase">
  </div>

  <div class="field span-2">
    <label>Data</label>
    <input id="data" disabled class="uppercase">
  </div>

  <div class="field span-2">
    <label>Observa√ß√µes</label>
    <textarea id="obs" disabled class="uppercase"></textarea>
  </div>






<div class="field">
  <label>Apostila 1 (principal)</label>
  <select id="apostila1" disabled>
    <option value="">‚Äî Nenhuma ‚Äî</option>
  </select>
</div>

<div class="field">
  <label>Apostila 2 (opcional)</label>
  <select id="apostila2" disabled>
    <option value="">‚Äî Nenhuma ‚Äî</option>
  </select>
</div>

<div class="field">
  <label>Apostila 3 (opcional)</label>
  <select id="apostila3" disabled>
    <option value="">‚Äî Nenhuma ‚Äî</option>
  </select>
</div>

<div class="field">
  <label>Apostila 4 (opcional)</label>
  <select id="apostila4" disabled>
    <option value="">‚Äî Nenhuma ‚Äî</option>
  </select>
</div>

<div class="field">
  <label>Apostila 5 (opcional)</label>
  <select id="apostila5" disabled>
    <option value="">‚Äî Nenhuma ‚Äî</option>
  </select>
</div>

<div class="field">
  <label>Apostila 6 (opcional)</label>
  <select id="apostila6" disabled>
    <option value="">‚Äî Nenhuma ‚Äî</option>
  </select>
</div>

  

  

  

  

  

  
  <div class="field span-2">
  <label></label>
  <div style="display:flex; gap:8px;">
    <input id="modelo" disabled class="hidden-input">
    
    <button  id="btnVerModelo"  type="button"   onclick="abrirModalModelos()"   disabled>Selecione Modelo Certificado & se QRcode</button>
    </div>
    </div>

 

    
   


  <div class="field">
  <label>Modelo Encontrado</label>  
  <div id="previewModelo" style="margin-top:6px; font-size:13px;"></div>
  </div>  


  <div class="field">
  <label>Link Verificado</label>  
  <div id="previewVerificacao" style="margin-top:6px; font-size:13px;"></div>
    
  </div>  

  
    <div class="field">
    <label></label>
    <input id="urlVerificacao" disabled class="hidden-input">
    </div>

</div> <!-- FECHA .form-grid -->


<br>
 <!-- NAVEGA√á√ÉO -->
  <div class="nav">
    <button onclick="prev()">‚óÄ</button>
    <div class="counter" id="contador">0 de 0</div>
    <button onclick="next()">‚ñ∂</button>
  </div> 

  
  <!-- A√á√ïES -->
  <div class="actions">
    <button class="btn-novo" onclick="novo()">Novo</button>
    <button class="btn-editar" onclick="editar()">Editar</button>
    <button class="secondary" onclick="duplicar()">Duplicar & Editar</button>
    <button class="btn-salvar" onclick="salvar()">Salvar</button>
    <button class="danger hidden" onclick="excluir()">Excluir</button>
  </div>

</div>
</div>


 
  
  
<script>
const API = window.IGC_CONFIG.APPS_SCRIPT_BASE;

let SENHA = "";
let PERFIL = "";

let cursos = [];
let index = 0;
let modo = "view";
let cursosOriginais = [];
let PERMISSOES = [];



  

async function login() {
  const senha = senhaLogin.value.trim();
  loginErro.innerText = "";

  if (!senha) {
    loginErro.innerText = "Informe a senha.";
    return;
  }

  const res = await fetch(API, {
    method: "POST",
    body: JSON.stringify({
      acao: "loginCursos",
      senha
    })
  }).then(r => r.json());

  if (!res.ok || !res.permissoes.includes("GERENCIAR_CURSO")) {
  loginErro.innerText = "Acesso n√£o autorizado.";
  return;
}

  // ‚úÖ LOGIN OK
  SENHA = senha;
  PERFIL = res.perfil;
  PERMISSOES = res.permissoes || [];

  // some login
  loginBox.style.display = "none";

  // mostra loading
  loadingBox.style.display = "flex";

  // carrega dados
  await carregarApostilas();
  await carregarCursos();
  

  // delay padr√£o do sistema
  setTimeout(() => {
    loadingBox.style.display = "none";
    appBox.style.display = "block";
    bloquear(true);


    // üîê CONTROLE DE PERMISS√ÉO (AQUI √â O LUGAR CERTO)
  const podeGerenciarCurso = PERMISSOES.includes("GERENCIAR_CURSO");

  if (!podeGerenciarCurso) {
    document.querySelector(".btn-novo").style.display   = "none";
    document.querySelector(".btn-editar").style.display = "none";
    document.querySelector(".btn-salvar").style.display = "none";
    document.querySelector(".danger").style.display     = "none";
  }


}, 1500);

}



async function carregarApostilas() {
  const res = await fetch(API + "?acao=listarApostilas")
    .then(r => r.json());

  for (let i = 1; i <= 6; i++) {
    const select = document.getElementById(`apostila${i}`);

    select.innerHTML = `<option value="">‚Äî Nenhuma ‚Äî</option>`;

    res.forEach(a => {
      const opt = document.createElement("option");
      opt.value = a.pdfId;      // üîë ID REAL
      opt.textContent = a.nome; // üëÅÔ∏è VISUAL
      select.appendChild(opt);
    });
  }
}







// üîí REGRA DE NEG√ìCIO CENTRALIZADA IMPEDE EDITAR REGISTROS INATIVOS

function aplicarRestricaoInativo(curso) {
  const btnEditar   = document.querySelector(".btn-editar");
  const btnDuplicar = document.querySelector(".secondary");

  const inativo = String(curso.ativo).toUpperCase() !== "TRUE";

  btnEditar.disabled   = inativo;
  btnDuplicar.disabled = inativo;

  // (opcional UX profissional)
  btnEditar.title   = inativo ? "Curso inativo n√£o pode ser editado" : "";
  btnDuplicar.title = inativo ? "Curso inativo n√£o pode ser duplicado" : "";
}






  


// üîí REGRA DE NEG√ìCIO IMPEDE GRAVA√á√ÉO DE TURMA COM NOME IGUAL



function turmaJaExiste(nomeTurma, idAtual = null) {
  const turmaNormalizada = nomeTurma.trim().toUpperCase();

  return cursosOriginais.some(c => {
    if (!c.turma) return false;

    const mesmaTurma =
      c.turma.trim().toUpperCase() === turmaNormalizada;

    const mesmoRegistro =
      idAtual && String(c.id) === String(idAtual);

    return mesmaTurma && !mesmoRegistro;
  });
}

function validarTurma() {
  const valor = turma.value.trim();
  if (!valor) return;

  const idAtual = cursoId.value || null;

  if (turmaJaExiste(valor, idAtual)) {
    alert("‚ö†Ô∏è J√° existe uma turma cadastrada com esse nome.\n\nUtilize um nome diferente.");
    turma.value = "";
    turma.focus();
  }
}





  
  


  






  
async function carregarCursos(idManter = null) {
 cursosOriginais = await fetch(API + "?acao=listarCursosAdmin")
  .then(r => r.json());

  cursos = [...cursosOriginais];

  if (!cursos.length) {
    contador.innerText = "0 de 0";
    return;
  }

  if (idManter) {
    const idx = cursos.findIndex(c => c.id === idManter);
    index = idx >= 0 ? idx : 0;
  } else {
    index = Math.min(index, cursos.length - 1);
  }

  preencher(cursos[index]);

  controlarBotoes({
    novo: true,
    editar: true,
    salvar: false,
    excluir: true
  });
}




function controlarBotoes({ novo, editar, salvar, excluir }) {
  const cursoAtual = cursos[index];

  document.querySelector(".btn-novo").disabled   = !novo;
  document.querySelector(".btn-salvar").disabled = !salvar;
  document.querySelector(".danger").disabled     = !excluir;

  // ‚ö†Ô∏è editar e duplicar dependem do status
  const inativo = cursoAtual && String(cursoAtual.ativo).toUpperCase() !== "TRUE";

  document.querySelector(".btn-editar").disabled   = inativo || !editar;
  document.querySelector(".secondary").disabled    = inativo || !editar;
}


  
  
function preencher(c) {
  cursoId.value = c.id || "";
  nome.value = c.nome || "";
  turma.value = c.turma || "";
  carga.value = c.carga
  ? c.carga.toString().replace(/\D/g, "")
  : "";
  local.value = c.local || "";
  data.value = c.data || "";
  obs.value = c.obs || "";
  ativo.value = String(c.ativo).toUpperCase() === "TRUE"
  ? "TRUE"
  : "FALSE";
  modelo.value = c.modelo || "";
  urlVerificacao.value = c.urlVerificacao || "";
  apostila1.value = c.apostilas?.[0] || "";
  apostila2.value = c.apostilas?.[1] || "";
  apostila3.value = c.apostilas?.[2] || "";
  apostila4.value = c.apostilas?.[3] || "";
  apostila5.value = c.apostilas?.[4] || "";
  apostila6.value = c.apostilas?.[5] || "";
  




  

  atualizarPreviewModelo();
  atualizarPreviewVerificacao();
  
  contador.innerText = `${index + 1} de ${cursos.length}`;





// üîí REGRA DE NEG√ìCIO CENTRALIZADA IMPEDE EDITAR REGISTROS INATIVOS
  aplicarRestricaoInativo(c);



  
}



function aplicarFiltro() {
  const textoCurso = filtroCurso.value.trim().toUpperCase();
  const textoTurma = filtroTurma.value.trim().toUpperCase();

  cursos = cursosOriginais.filter(c => {
    const nomeMatch =
      !textoCurso || (c.nome || "").toUpperCase().includes(textoCurso);

    const turmaMatch =
      !textoTurma || (c.turma || "").toUpperCase().includes(textoTurma);

    return nomeMatch && turmaMatch;
  });

  if (!cursos.length) {
    contador.innerText = "0 de 0";
    return;
  }

  index = 0;
  preencher(cursos[index]);
}





  
function bloquear(b) {
  document.querySelectorAll(
    "#appBox input, #appBox textarea, #appBox select"
  ).forEach(el => {
    if (el.classList.contains("no-lock")) return;
    el.disabled = b;
  });

  // üîí bot√£o do modal segue o modo
  document.getElementById("btnVerModelo").disabled = b;
  
}




function prev() {
  if (index > 0) index--;
  preencher(cursos[index]);

  bloquear(true);

  controlarBotoes({
    novo: true,
    editar: true,
    salvar: false,
    excluir: true
  });
}

function next() {
  if (index < cursos.length - 1) index++;
  preencher(cursos[index]);

  bloquear(true);

  controlarBotoes({
    novo: true,
    editar: true,
    salvar: false,
    excluir: true
  });
}


async function novo () {
  modo = "novo";

  await carregarApostilas();
  
  cursoId.value = "";

  document.querySelectorAll(
  "#appBox input, #appBox textarea, #appBox select"
).forEach(el => {
  el.disabled = false;
  el.value = "";
});


  ativo.value = "TRUE";

  // ‚úÖ LIMPEZA FOR√áADA DOS PREVIEWS (AQUI EST√Å A CHAVE)
  document.getElementById("previewModelo").innerHTML = "";
  document.getElementById("previewVerificacao").innerHTML = "";

controlarBotoes({
    novo: false,
    editar: false,
    salvar: true,
    excluir: false
  });
 document.getElementById("btnVerModelo").disabled = false; 
}




  
function editar() {
  if (!cursoId.value) return;

  modo = "editar";

  document.querySelectorAll(
    "#appBox input, #appBox textarea, #appBox select"
  ).forEach(el => el.disabled = false);

  controlarBotoes({
    novo: false,
    editar: false,
    salvar: true,
    excluir: false
  });

  document.getElementById("btnVerModelo").disabled = false;
}


function forcarCaixaAlta() {
  document.querySelectorAll(".uppercase").forEach(el => {
    el.value = el.value.toUpperCase();
  });
}




 function duplicar() {
  if (!cursoId.value) return;

  modo = "novo";

  // limpa ID ‚Üí for√ßa cria√ß√£o de novo registro
  cursoId.value = "";

  // habilita edi√ß√£o
  document.querySelectorAll(
    "#appBox input, #appBox textarea, #appBox select"
  ).forEach(el => el.disabled = false);

  controlarBotoes({
    novo: false,
    editar: false,
    salvar: true,
    excluir: false
  });
}
 

  
  

async function salvar() {

  


  // ‚úÖ VALIDA√á√ÉO DE CAMPOS OBRIGAT√ìRIOS
if (
  !nome.value.trim() ||
  !turma.value.trim() ||
  !carga.value.trim() ||
  !ativo.value ||
  !local.value.trim() ||
  !data.value.trim()
) {
  alert("‚ö†Ô∏è Preencha todos os campos obrigat√≥rios:\n\n‚Ä¢ Nome\n‚Ä¢ Turma\n‚Ä¢ Carga hor√°ria\n‚Ä¢ Status\n‚Ä¢ Local\n‚Ä¢ Data");
  return;
}


  const btnSalvar = document.querySelector(".btn-salvar");
  btnSalvar.textContent = "Salvando...";  
  

  forcarCaixaAlta();

  const cargaNumerica = carga.value.replace(/\D/g, "");
  const cargaFormatada = cargaNumerica ? `${cargaNumerica} HORAS` : "";


if (!modelo.value || modelo.value.trim().length < 20) {
  alert("‚ö†Ô∏è ID do modelo de certificado inv√°lido.");
  return;
}



// üîí VALIDA√á√ÉO DE TURMA √öNICA
if (turmaJaExiste(turma.value, cursoId.value || null)) {
  alert("‚ö†Ô∏è J√° existe uma turma cadastrada com esse nome.\n\nAltere o nome da turma para continuar.");
  btnSalvar.textContent = "Salvar";
  return;
}

  
  const curso = {
  id: cursoId.value || null,
  nome: nome.value,
  turma: turma.value,
  carga: cargaFormatada,
  local: local.value,
  data: data.value,
  obs: obs.value,
  ativo: ativo.value === "TRUE",
  modelo: modelo.value,
  urlVerificacao: urlVerificacao.value,

  apostilaId1: apostila1.value || "",
  apostilaId2: apostila2.value || "",
  apostilaId3: apostila3.value || "",
  apostilaId4: apostila4.value || "",
  apostilaId5: apostila5.value || "",
  apostilaId6: apostila6.value || ""
};


  const idAtual = curso.id;

  await fetch(API, {
    method: "POST",
    body: JSON.stringify({
      acao: "salvarCurso",
      senha: SENHA,
      curso
    })
  });

  bloquear(true);
  await carregarCursos(idAtual);
  btnSalvar.textContent = "Salvar";
}





  

async function excluir() {
  if (!cursoId.value) return;
  if (!confirm("Excluir este curso?")) return;

  
  const btnExcluir = document.querySelector(".danger");
  btnExcluir.textContent = "Excluindo...";  

  await fetch(API, {
    method: "POST",
    body: JSON.stringify({
      acao: "excluirCurso",
      senha: SENHA,
      id: cursoId.value
    })
  });

  carregarCursos();
  btnExcluir.textContent = "Excluir";
}


function somenteNumeros(el) {
  el.value = el.value.replace(/\D/g, "");
}




  function atualizarPreviewModelo() {
  const id = modelo.value.trim();
  const box = document.getElementById("previewModelo");

  if (id.length > 20) {
    box.innerHTML = `
      <div class="preview-wrapper">
    <div class="preview-box">
      <iframe 
        src="https://docs.google.com/presentation/d/${id}/preview"
        loading="lazy">
      </iframe>
    </div>
  </div>
    `;
  } else {
    box.innerHTML = "";
  }
}

function atualizarPreviewVerificacao() {
  const url = urlVerificacao.value.trim();
  const box = document.getElementById("previewVerificacao");

  if (url.startsWith("http")) {
    box.innerHTML = `
      <div class="preview-wrapper">
    <div class="preview-box">
      <iframe 
        src="${url}"
        loading="lazy">
      </iframe>
    </div>
  </div>
    `;
  } else {
    box.innerHTML = "";
  }
}




function fecharModal() {
  modeloSelecionadoAtivo = null;

  document.querySelectorAll(".modelo-card").forEach(card => {
    card.style.opacity = "1";
    card.querySelectorAll("button").forEach(btn => btn.disabled = false);
  });

  

modalOverlay.classList.remove("aberto");
document.body.style.overflow = "";



  
}


function copiarModelo(id) {
  modelo.value = id;
  atualizarPreviewModelo();
}

function copiarURL(url) {
  urlVerificacao.value = url;
  atualizarPreviewVerificacao();
}



function mostrarToast(msg) {
  const toast = document.getElementById("toast");
  toast.innerText = msg;
  toast.style.display = "block";

  setTimeout(() => {
    toast.style.display = "none";
  }, 2500);
}




async function abrirModalModelos() {

  const dados = await fetch(API + "?acao=listarModelosCertificado")
    .then(r => r.json());

  const lista = document.getElementById("listaModelos");
  lista.innerHTML = "";
  lista.className = "lista-modelos";

  dados.forEach(m => {

    const div = document.createElement("div");
    div.className = "modelo-card";
    div.dataset.temQr = "false";

    div.innerHTML = `
      <div class="status-qrcode">üî¥ QR Code removido</div>
      <div class="modelo-nome">${m.nome}</div>

      <div class="modelo-acoes">
        <button class="btn-id">Selecionar Modelo</button>
        <button class="btn-url">Inserir QR Code</button>
        <button class="btn-remover" disabled>Remover QR Code</button>
      </div>
    `;

    const btnSelecionar = div.querySelector(".btn-id");
    const btnInserir   = div.querySelector(".btn-url");
    const btnRemover   = div.querySelector(".btn-remover");
    const status       = div.querySelector(".status-qrcode");

    /* =========================
       SELECIONAR MODELO
       ========================= */
    btnSelecionar.onclick = () => {
      modelo.value = m.modeloId;
      urlVerificacao.value = "";
      atualizarPreviewModelo();
      atualizarPreviewVerificacao();
    };

    /* =========================
       INSERIR QR CODE
       ========================= */
    btnInserir.onclick = () => {
      if (!m.url) return;

      div.dataset.temQr = "true";
      urlVerificacao.value = m.url;

      btnInserir.disabled = true;
      btnRemover.disabled = false;

      status.innerText = "‚úî QR Code inserido";
      atualizarPreviewVerificacao();
    };

    /* =========================
       REMOVER QR CODE
       ========================= */
    btnRemover.onclick = () => {
      div.dataset.temQr = "false";
      urlVerificacao.value = "";

      btnInserir.disabled = false;
      btnRemover.disabled = true;

      status.innerText = "üî¥ QR Code removido";
      atualizarPreviewVerificacao();
    };

    lista.appendChild(div);
  });

  modalOverlay.classList.add("aberto");
  document.body.style.overflow = "hidden";
}


  

  
modelo.addEventListener("input", atualizarPreviewModelo);
urlVerificacao.addEventListener("input", atualizarPreviewVerificacao);
  
  
</script>



<!-- üî≥ MODAL OVERLAY -->
<div id="modalOverlay" class="modal-overlay">
  <div class="modal-box modal-modelos">

    <!-- CABE√áALHO -->
    <div class="modal-header">
      <h2>Selecione o modelo de certificado</h2>
    </div>

    <!-- CONTE√öDO -->
    <div class="modal-content" id="listaModelos">
      <!-- cards gerados via JS -->
    </div>

    <!-- RODAP√â -->
    <div class="modal-footer">
      <button class="btn-fechar" onclick="fecharModal()">Fechar</button>
    </div>

  </div>
</div>

<div id="toast" style="
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #020617;
  color: #e5e7eb;
  padding: 12px 20px;
  border-radius: 8px;
  border: 1px solid #334155;
  display: none;
  z-index: 100000;
  font-size: 14px;
">
</div>


  
</body>
</html>
